//-----------------------------------------------------------------------
//------------------- Copyright (c) samisalreadytaken -------------------
//                       github.com/samisalreadytaken
//-----------------------------------------------------------------------
local _VERSION = "vs_library v2.41.0",
ROOT=::getroottable(),CONST=::getconsttable();delete CONST.DEG2RADDIV2;delete CONST.RAD2DEG2;delete CONST.PI2;delete CONST.PIDIV2;delete CONST.FLT_MAX_N;delete CONST.MASK_NPCWORLDSTATIC;delete CONST.MASK_SOLID;if("VS"in ROOT&&typeof::VS=="table"){if(::VS.version==_VERSION){if(!(0 in::VS))::VS[0]<-0;if(::VS[0]>=0x3E)return}}else::VS<-{};;local VS={[0]=0x3E,version=_VERSION}if(::print.getinfos().native)::Msg<-::print;;if(::EntFireByHandle.getinfos().native)::DoEntFireByInstanceHandle<-::EntFireByHandle;;local AddEvent=::DoEntFireByInstanceHandle,Fmt=::format,TI=::FrameTime();if(TI==0.0)TI=0.015625;;local PORTAL2="CPortal_Player"in ROOT&&"TurnOnPotatos"in::CPortal_Player&&::CPortal_Player.TurnOnPotatos.getinfos().native;{const FLT_EPSILON=1.192092896e-7;;const FLT_MAX=3.402823466e+38;;const FLT_MIN=1.175494351e-38;;const INT_MAX=0x7FFFFFFF;;const INT_MIN=0x80000000;;const DEG2RAD=0.017453293;;const RAD2DEG=57.295779513;;const PI=3.141592654;;const RAND_MAX=0x7FFF;;const MAX_COORD_FLOAT=16384.0;;const MAX_TRACE_LENGTH=56755.840862417;;::CONST<-CONST;::DEG2RAD<-DEG2RAD;::RAD2DEG<-RAD2DEG;::MAX_COORD_FLOAT<-MAX_COORD_FLOAT;::MAX_TRACE_LENGTH<-MAX_TRACE_LENGTH;const DEG2RADDIV2=0.008726646;;const RAD2DEG2=114.591559026;;const PI2=6.283185307;;const PIDIV2=1.570796327;;const FLT_MAX_N=-3.402823466e+38;;class::Quaternion{x=0.0;y=0.0;z=0.0;w=0.0;constructor(_x=0.0,_y=0.0,_z=0.0,_w=0.0){x=_x;y=_y;z=_z;w=_w}function IsValid(){return(x>FLT_MAX_N&&x<FLT_MAX)&&(y>FLT_MAX_N&&y<FLT_MAX)&&(z>FLT_MAX_N&&z<FLT_MAX)&&(w>FLT_MAX_N&&w<FLT_MAX)}function _get(i){switch(i){case 0:return x;case 1:return y;case 2:return z;case 3:return w}return rawget(i)}function _set(i,v){switch(i){case 0:return x=v;case 1:return y=v;case 2:return z=v;case 3:return w=v}return rawset(i,v)}function _typeof(){return"Quaternion"}function _tostring():(Fmt){return Fmt("Quaternion(%.6g, %.6g, %.6g, %.6g)",x,y,z,w)}}function Quaternion::_add(d):(Quaternion){return Quaternion(x+d.x,y+d.y,z+d.z,w+d.w)}function Quaternion::_sub(d):(Quaternion){return Quaternion(x-d.x,y-d.y,z-d.z,w-d.w)}function Quaternion::_mul(d):(Quaternion){return Quaternion(x*d,y*d,z*d,w*d)}function Quaternion::_div(d):(Quaternion){local f=1.0/d;return Quaternion(x*f,y*f,z*f,w*f)}function Quaternion::_unm():(Quaternion){return Quaternion(-x,-y,-z,-w)}class::matrix3x4_t{constructor(m00=0.0,m01=0.0,m02=0.0,m03=0.0,m10=0.0,m11=0.0,m12=0.0,m13=0.0,m20=0.0,m21=0.0,m22=0.0,m23=0.0){m=[[m00,m01,m02,m03],[m10,m11,m12,m13],[m20,m21,m22,m23]]}function Init(m00=0.0,m01=0.0,m02=0.0,m03=0.0,m10=0.0,m11=0.0,m12=0.0,m13=0.0,m20=0.0,m21=0.0,m22=0.0,m23=0.0){local m0=m[0],m1=m[1],m2=m[2];m0[0]=m00;m0[1]=m01;m0[2]=m02;m0[3]=m03;m1[0]=m10;m1[1]=m11;m1[2]=m12;m1[3]=m13;m2[0]=m20;m2[1]=m21;m2[2]=m22;m2[3]=m23}function _cloned(src){src=src.m;constructor(src[0][0],src[0][1],src[0][2],src[0][3],src[1][0],src[1][1],src[1][2],src[1][3],src[2][0],src[2][1],src[2][2],src[2][3])}function _tostring():(Fmt){local m=m;return Fmt("[ (%.6g, %.6g, %.6g), (%.6g, %.6g, %.6g), (%.6g, %.6g, %.6g), (%.6g, %.6g, %.6g) ]",m[0][0],m[0][1],m[0][2],m[1][0],m[1][1],m[1][2],m[2][0],m[2][1],m[2][2],m[0][3],m[1][3],m[2][3])}function _typeof(){return"matrix3x4_t"}function _get(i){switch(i){case 0:return m[0];case 1:return m[1];case 2:return m[2]}return rawget(i)}m=null}class::VMatrix extends matrix3x4_t{constructor(m00=0.0,m01=0.0,m02=0.0,m03=0.0,m10=0.0,m11=0.0,m12=0.0,m13=0.0,m20=0.0,m21=0.0,m22=0.0,m23=0.0,m30=0.0,m31=0.0,m32=0.0,m33=1.0){m=[[m00,m01,m02,m03],[m10,m11,m12,m13],[m20,m21,m22,m23],[m30,m31,m32,m33]]}function Identity(){local m=m;m[0][0]=m[1][1]=m[2][2]=m[3][3]=1.0;m[0][1]=m[0][2]=m[0][3]=m[1][0]=m[1][2]=m[1][3]=m[2][0]=m[2][1]=m[2][3]=m[3][0]=m[3][1]=m[3][2]=0.0}function _cloned(src){src=src.m;constructor(src[0][0],src[0][1],src[0][2],src[0][3],src[1][0],src[1][1],src[1][2],src[1][3],src[2][0],src[2][1],src[2][2],src[2][3],src[3][0],src[3][1],src[3][2],src[3][3])}function _tostring():(Fmt){local m=m;return Fmt("[ (%.6g, %.6g, %.6g, %.6g), (%.6g, %.6g, %.6g, %.6g), (%.6g, %.6g, %.6g, %.6g), (%.6g, %.6g, %.6g, %.6g) ]",m[0][0],m[0][1],m[0][2],m[0][3],m[1][0],m[1][1],m[1][2],m[1][3],m[2][0],m[2][1],m[2][2],m[2][3],m[3][0],m[3][1],m[3][2],m[3][3])}function _typeof(){return"VMatrix"}function _get(i){switch(i){case 0:return m[0];case 1:return m[1];case 2:return m[2];case 3:return m[3]}return rawget(i)}}VS.fabs<-function(f){if(0.0<=f)return f;return -f}local _VEC=Vector(),_QUAT=Quaternion(),fabs=VS.fabs;::max<-function(a,b){if(a>b)return a;return b}::min<-function(a,b){if(a<b)return a;return b}::clamp<-function(v,n,x){if(x<n)return x;if(v<n)return n;if(v>x)return x;return v}VS.IsInteger<-function(f)return f.tointeger()==f;VS.IsLookingAt<-function(s,t,d,c){local l=t-s;l.Norm();return l.Dot(d)>=c}VS.GetAngle<-function(S,T):(atan2){local d=T-S,p=RAD2DEG*atan2(-d.z,d.Length2D()),y=RAD2DEG*atan2(d.y,d.x);d.x=p;d.y=y;d.z=0.0;return d}VS.VectorVectors<-function(F,R,U):(Vector){if(!F.x&&!F.y){R.y=-1.0;U.x=-F.z;R.x=R.z=U.y=U.z=0.0}else{local r=F.Cross(Vector(0.0,0.0,1.0));r.Norm();R.x=r.x;R.y=r.y;R.z=r.z;local u=r.Cross(F);u.Norm();U.x=u.x;U.y=u.y;U.z=u.z}}local VectorVectors=VS.VectorVectors;VS.AngleVectors<-function(A,F=_VEC,R=null,U=null):(sin,cos){local sr,cr,yr=DEG2RAD*A.y,sy=sin(yr),cy=cos(yr),pr=DEG2RAD*A.x,sp=sin(pr),cp=cos(pr);if(A.z){local rr=DEG2RAD*A.z;sr=-sin(rr);cr=cos(rr)}else{sr=0.0;cr=1.0};if(F){F.x=cp*cy;F.y=cp*sy;F.z=-sp};if(R){R.x=sr*sp*cy+cr*sy;R.y=sr*sp*sy-cr*cy;R.z=sr*cp};if(U){U.x=cr*sp*cy-sr*sy;U.y=cr*sp*sy+sr*cy;U.z=cr*cp};return F}VS.VectorAngles<-function(F,o=_VEC):(Vector,atan2){local y,p;if(!F.y&&!F.x){y=0.0;if(F.z>0.0)p=270.0;elsep=90.0}else{y=RAD2DEG*atan2(F.y,F.x);if(y<0.0)y+=360.0;p=RAD2DEG*atan2(-F.z,F.Length2D());if(p<0.0)p+=360.0};o.x=p;o.y=y;o.z=0.0;return o}VS.VectorYawRotate<-function(I,Y,o=_VEC):(sin,cos){local r=DEG2RAD*Y,sy=sin(r),cy=cos(r);o.x=I.x*cy-I.y*sy;o.y=I.x*sy+I.y*cy;o.z=I.z;return o}VS.YawToVector<-function(y):(Vector,sin,cos){local r=DEG2RAD*y;return Vector(cos(r),sin(r),0.0)}VS.VecToYaw<-function(v):(atan2){if(!v.y&&!v.x)return 0.0;return RAD2DEG*atan2(v.y,v.x)}VS.VecToPitch<-function(v):(atan2){if(!v.y&&!v.x){if(v.z<0.0)return 180.0;return -180.0};return RAD2DEG*atan2(-v.z,v.Length2D())}VS.VectorIsZero<-function(v){return !v.x&&!v.y&&!v.z}VS.VectorsAreEqual<-function(a,b,t=0.0){local x=a.x-b.x;if(0.0>x)x=-x;local y=a.y-b.y;if(0.0>y)y=-y;local z=a.z-b.z;if(0.0>z)z=-z;return(x<=t&&y<=t&&z<=t)}VS.AnglesAreEqual<-function(a,b,t=0.0){local d=(a-b)%360.0;if(d>180.0)d-=360.0;else if(-180.0>d)d+=360.0;;if(0.0>d)d=-d;return d<=t}VS.CloseEnough<-function(a,b,e=1.e-3){local d=a-b;if(0.0>d)d=-d;return d<=e}VS.Approach<-function(t,v,s){local d=t-v;if(d>s)return v+s;if(-s>d)return v-s;return t}VS.ApproachAngle<-function(t,v,s){t%=360.0;if(t>180.0)t-=360.0;else if(-180.0>t)t+=360.0;;v%=360.0;if(v>180.0)v-=360.0;else if(-180.0>v)v+=360.0;;local d=(t-v)%360.0;if(d>180.0)d-=360.0;else if(-180.0>d)d+=360.0;;if(s<0.0)s=-s;if(d>s)return v+s;if(-s>d)return v-s;return t}VS.AngleDiff<-function(d,s){local a=(d-s)%360.0;if(a>180.0)return a-360.0;if(-180.0>a)return a+360.0;return a}VS.AngleNormalize<-function(a){a%=360.0;if(a>180.0)return a-360.0;if(-180.0>a)return a+360.0;return a}VS.QAngleNormalize<-function(a){a.x%=360.0;if(a.x>180.0)a.x-=360.0;else if(-180.0>a.x)a.x+=360.0;;a.y%=360.0;if(a.y>180.0)a.y-=360.0;else if(-180.0>a.y)a.y+=360.0;;a.z%=360.0;if(a.z>180.0)a.z-=360.0;else if(-180.0>a.z)a.z+=360.0;;return a}VS.SnapDirectionToAxis<-function(V,E=0.002){local p=1.0-E,f=V.x<0.0;if((f?-V.x:V.x)>p){V.x=f?-1.0:1.0;V.y=V.z=0.0;return V};f=V.y<0.0;if((f?-V.y:V.y)>p){V.y=f?-1.0:1.0;V.z=V.x=0.0;return V};f=V.z<0.0;if((f?-V.z:V.z)>p){V.z=f?-1.0:1.0;V.x=V.y=0.0;return V}}VS.VectorNegate<-function(v){v.x=-v.x;v.y=-v.y;v.z=-v.z;return v}VS.VectorCopy<-function(s,d){d.x=s.x;d.y=s.y;d.z=s.z;return d}VS.VectorMin<-function(a,b,o=_VEC){if(a.x<b.x)o.x=a.x;else o.x=b.x;if(a.y<b.y)o.y=a.y;else o.y=b.y;if(a.z<b.z)o.z=a.z;else o.z=b.z;return o}VS.VectorMax<-function(a,b,o=_VEC){if(a.x>b.x)o.x=a.x;else o.x=b.x;if(a.y>b.y)o.y=a.y;else o.y=b.y;if(a.z>b.z)o.z=a.z;else o.z=b.z;return o}VS.VectorAbs<-function(v){if(0.0>v.x)v.x=-v.x;if(0.0>v.y)v.y=-v.y;if(0.0>v.z)v.z=-v.z;return v}VS.VectorAdd<-function(a,b,o){o.x=a.x+b.x;o.y=a.y+b.y;o.z=a.z+b.z;return o}VS.VectorSubtract<-function(a,b,o){o.x=a.x-b.x;o.y=a.y-b.y;o.z=a.z-b.z;return o}VS.VectorScale<-function(a,b,o){o.x=a.x*b;o.y=a.y*b;o.z=a.z*b;return o}VS.VectorMA<-function(v,t,f,o=_VEC){o.x=v.x+t*f.x;o.y=v.y+t*f.y;o.z=v.z+t*f.z;return o}local VectorAdd=VS.VectorAdd,VectorSubtract=VS.VectorSubtract;VS.ComputeVolume<-function(n,x){return(x-n).LengthSqr()}VS.RandomVector<-function(n=-RAND_MAX,x=RAND_MAX):(Vector,RandomFloat){return Vector(RandomFloat(n,x),RandomFloat(n,x),RandomFloat(n,x))}VS.RandomVectorInUnitSphere<-function(o):(rand,sin,cos,acos,pow){local p=acos(1.0-rand()*0.00006103702),t=rand()*0.00019175345,r=pow(rand()*0.00003051851,0.333333),s=r*sin(p);o.x=s*cos(t);o.y=s*sin(t);o.z=r*cos(p);return r}VS.RandomVectorOnUnitSphere<-function(o):(rand,sin,cos,acos){local p=acos(1.0-rand()*0.00006103702),t=rand()*0.00019175345,s=sin(p);o.x=s*cos(t);o.y=s*sin(t);o.z=cos(p)}VS.ExponentialDecay<-function(v,t,dt):(log,exp){return exp(log(v)/t*dt)}VS.ExponentialDecay2<-function(v,dt):(exp){return exp(-0.6931471806/v*dt)}VS.ExponentialDecayIntegral<-function(v,t,dt):(log,pow){return(pow(v,dt/t)*t-t)/log(v)}VS.SimpleSpline<-function(v){local q=v*v;return 3.0*q-2.0*q*v}VS.SimpleSplineRemapVal<-function(v,A,B,C,D){if(A==B){if(v>=B)return D;return C};local c=(v-A)/(B-A),q=c*c;return C+(D-C)*(3.0*q-2.0*q*c)}VS.SimpleSplineRemapValClamped<-function(v,A,B,C,D){if(A==B){if(v>=B)return D;return C};local c=(v-A)/(B-A);if(c<0.0)c=0.0;else if(c>1.0)c=1.0;;local q=c*c;return C+(D-C)*(3.0*q-2.0*q*c)}VS.RemapVal<-function(v,A,B,C,D){if(A==B){if(v>=B)return D;return C};return C+(D-C)*(v-A)/(B-A)}VS.RemapValClamped<-function(v,A,B,C,D){if(A==B){if(v>=B)return D;return C};local c=(v-A)/(B-A);if(c<0.0)c=0.0;else if(c>1.0)c=1.0;;return C+(D-C)*c}VS.Bias<-function(x,b):(log,pow){local e=0.0;if(-1.0!=b)e=log(b)*-1.442695041;return pow(x,e)}local Bias=VS.Bias;VS.Gain<-function(x,b):(Bias){if(x<0.5)return 0.5*Bias(2.0*x,1.0-b);return 1.0-0.5*Bias(2.0-2.0*x,1.0-b)}VS.SmoothCurve<-function(x):(cos){return(1.0-cos(x*PI))*0.5}VS.MovePeak<-function(x,k){if(x<k)return x*0.5/k;return 0.5+0.5*(x-k)/(1.0-k)}local MovePeak=VS.MovePeak,Gain=VS.Gain;VS.SmoothCurve_Tweak<-function(x,k,s):(MovePeak,Gain,cos){return(1.0-cos(Gain(MovePeak(x,k),s)*PI))*0.5}VS.Lerp<-function(A,B,f){return A+(B-A)*f}VS.FLerp<-function(f1,f2,i1,i2,x){return f1+(f2-f1)*(x-i1)/(i2-i1)}VS.VectorLerp<-function(v1,v2,f,o=_VEC){local v=v1+(v2-v1)*f;o.x=v.x;o.y=v.y;o.z=v.z;return o}VS.DotProductAbs<-function(in1,in2){local x=in1.x*in2.x,y=in1.y*in2.y,z=in1.z*in2.z;if(0.0>x)x=-x;if(0.0>y)y=-y;if(0.0>z)z=-z;return x+y+z}local DotProductAbs=VS.DotProductAbs;VS.VectorTransform<-function(in1,in2,out=_VEC){in2=in2.m;local x=in1.x*in2[0][0]+in1.y*in2[0][1]+in1.z*in2[0][2]+in2[0][3],y=in1.x*in2[1][0]+in1.y*in2[1][1]+in1.z*in2[1][2]+in2[1][3],z=in1.x*in2[2][0]+in1.y*in2[2][1]+in1.z*in2[2][2]+in2[2][3];out.x=x;out.y=y;out.z=z;return out}VS.VectorITransform<-function(in1,in2,out=_VEC){in2=in2.m;local in1t0=in1.x-in2[0][3],in1t1=in1.y-in2[1][3],in1t2=in1.z-in2[2][3],x=in1t0*in2[0][0]+in1t1*in2[1][0]+in1t2*in2[2][0],y=in1t0*in2[0][1]+in1t1*in2[1][1]+in1t2*in2[2][1],z=in1t0*in2[0][2]+in1t1*in2[1][2]+in1t2*in2[2][2];out.x=x;out.y=y;out.z=z;return out}VS.VectorRotate<-function(in1,in2,out=_VEC){in2=in2.m;local x=in1.x*in2[0][0]+in1.y*in2[0][1]+in1.z*in2[0][2],y=in1.x*in2[1][0]+in1.y*in2[1][1]+in1.z*in2[1][2],z=in1.x*in2[2][0]+in1.y*in2[2][1]+in1.z*in2[2][2];out.x=x;out.y=y;out.z=z;return out}local VectorRotate=VS.VectorRotate;VS.VectorRotate2<-function(in1,in2,out=_VEC):(matrix3x4_t,VectorRotate){local m=matrix3x4_t();AngleMatrix(in2,null,m);return VectorRotate(in1,m,out)}VS.VectorRotate3<-function(in1,in2,out=_VEC){local in2x=in2.x,in2y=in2.y,in2z=in2.z,in2w=in2.w,qvx=in2y*in1.z-in2z*in1.y+in2w*in1.x,qvy=in2z*in1.x+in2w*in1.y-in2x*in1.z,qvz=in2x*in1.y-in2y*in1.x+in2w*in1.z,qvw=in2x*in1.x+in2y*in1.y+in2z*in1.z;out.x=qvx*in2w-qvy*in2z+qvz*in2y+qvw*in2x;out.y=qvx*in2z+qvy*in2w-qvz*in2x+qvw*in2y;out.z=qvy*in2x+qvz*in2w+qvw*in2z-qvx*in2y;return out}VS.VectorIRotate<-function(in1,in2,out=_VEC){in2=in2.m;local x=in1.x*in2[0][0]+in1.y*in2[1][0]+in1.z*in2[2][0],y=in1.x*in2[0][1]+in1.y*in2[1][1]+in1.z*in2[2][1],z=in1.x*in2[0][2]+in1.y*in2[1][2]+in1.z*in2[2][2];out.x=x;out.y=y;out.z=z;return out}local VectorITransform=VS.VectorITransform,VectorTransform=VS.VectorTransform,VectorIRotate=VS.VectorIRotate;VS.VectorMatrix<-function(F,m):(Vector,VectorVectors){local r=Vector(),u=Vector();VectorVectors(F,r,u);m=m.m;m[0][0]=F.x;m[1][0]=F.y;m[2][0]=F.z;m[0][1]=-r.x;m[1][1]=-r.y;m[2][1]=-r.z;m[0][2]=u.x;m[1][2]=u.y;m[2][2]=u.z}VS.MatrixVectors<-function(m,F,R,U){m=m.m;F.x=m[0][0];F.y=m[1][0];F.z=m[2][0];R.x=-m[0][1];R.y=-m[1][1];R.z=-m[2][1];U.x=m[0][2];U.y=m[1][2];U.z=m[2][2]}VS.MatrixAngles<-function(m,A=_VEC,T=null):(sqrt,atan2){m=m.m;if(T){T.x=m[0][3];T.y=m[1][3];T.z=m[2][3]};local fx=m[0][0],fy=m[1][0],fz=m[2][0],l0=m[0][1],l1=m[1][1],l2=m[2][1],u2=m[2][2],d=sqrt(fx*fx+fy*fy);if(d>0.001){A.y=RAD2DEG*atan2(fy,fx);A.x=RAD2DEG*atan2(-fz,d);A.z=RAD2DEG*atan2(l2,u2)}else{A.y=RAD2DEG*atan2(-l0,l1);A.x=RAD2DEG*atan2(-fz,d);A.z=0.0};return A}VS.AngleMatrix<-function(A,T,m):(sin,cos){local ay=DEG2RAD*A.y,ax=DEG2RAD*A.x,az=DEG2RAD*A.z,sy=sin(ay),cy=cos(ay),sp=sin(ax),cp=cos(ax),sr=sin(az),cr=cos(az),crcy=cr*cy,crsy=cr*sy,srcy=sr*cy,srsy=sr*sy;m=m.m;m[0][0]=cp*cy;m[1][0]=cp*sy;m[2][0]=-sp;m[0][1]=sp*srcy-crsy;m[1][1]=sp*srsy+crcy;m[2][1]=sr*cp;m[0][2]=sp*crcy+srsy;m[1][2]=sp*crsy-srcy;m[2][2]=cr*cp;if(T){m[0][3]=T.x;m[1][3]=T.y;m[2][3]=T.z}else m[0][3]=m[1][3]=m[2][3]=0.0}VS.AngleIMatrix<-function(A,T,mat):(sin,cos,VectorRotate){local ay=DEG2RAD*A.y,ax=DEG2RAD*A.x,az=DEG2RAD*A.z,sy=sin(ay),cy=cos(ay),sp=sin(ax),cp=cos(ax),sr=sin(az),cr=cos(az),srsp=sr*sp,crsp=cr*sp,m=mat.m;m[0][0]=cp*cy;m[0][1]=cp*sy;m[0][2]=-sp;m[1][0]=srsp*cy-cr*sy;m[1][1]=srsp*sy+cr*cy;m[1][2]=sr*cp;m[2][0]=crsp*cy+sr*sy;m[2][1]=crsp*sy-sr*cy;m[2][2]=cr*cp;if(T){local v=VectorRotate(T,mat);m[0][3]=-v.x;m[1][3]=-v.y;m[2][3]=-v.z}else m[0][3]=m[1][3]=m[2][3]=0.0}local MatrixAngles=VS.MatrixAngles,AngleMatrix=VS.AngleMatrix,AngleIMatrix=VS.AngleIMatrix;VS.QuaternionsAreEqual<-function(a,b,t=0.0){local x=a.x-b.x;if(0.0>x)x=-x;local y=a.y-b.y;if(0.0>y)y=-y;local z=a.z-b.z;if(0.0>z)z=-z;local w=a.w-b.w;if(0.0>w)w=-w;return(x<=t&&y<=t&&z<=t&&w<=t)}VS.QuaternionNormalize<-function(q):(sqrt){local r=q.x*q.x+q.y*q.y+q.z*q.z+q.w*q.w;if(r){local ir=1.0/sqrt(r);q.w*=ir;q.z*=ir;q.y*=ir;q.x*=ir};return r}VS.QuaternionAlign<-function(p,q,qt=_QUAT){local px=p.x,py=p.y,pz=p.z,pw=p.w,qx=q.x,qy=q.y,qz=q.z,qw=q.w,a=(px-qx)*(px-qx)+(py-qy)*(py-qy)+(pz-qz)*(pz-qz)+(pw-qw)*(pw-qw),b=(px+qx)*(px+qx)+(py+qy)*(py+qy)+(pz+qz)*(pz+qz)+(pw+qw)*(pw+qw);if(a>b){qt.x=-qx;qt.y=-qy;qt.z=-qz;qt.w=-qw}else if(qt!=q){qt.x=qx;qt.y=qy;qt.z=qz;qt.w=qw};;return qt}local QuaternionNormalize=VS.QuaternionNormalize,QuaternionAlign=VS.QuaternionAlign;VS.QuaternionMult<-function(p,q,qt=_QUAT):(QuaternionAlign,Quaternion){if(p==qt)return QuaternionMult(Quaternion(p.x,p.y,p.z,p.w),q,qt);local q2=QuaternionAlign(p,q),px=p.x,py=p.y,pz=p.z,pw=p.w,qx=q2.x,qy=q2.y,qz=q2.z,qw=q2.w;qt.x=px*qw+py*qz-pz*qy+pw*qx;qt.y=py*qw+pz*qx+pw*qy-px*qz;qt.z=px*qy-py*qx+pz*qw+pw*qz;qt.w=pw*qw-px*qx-py*qy-pz*qz;return qt}local QuaternionMult=VS.QuaternionMult;VS.QuaternionConjugate<-function(p,q){q.x=-p.x;q.y=-p.y;q.z=-p.z;q.w=p.w}VS.QuaternionMA<-function(p,s,q,qt=_QUAT):(Quaternion,QuaternionNormalize,QuaternionMult){local q1=Quaternion();QuaternionScale(q,s,q1);local p1=QuaternionMult(p,q1);QuaternionNormalize(p1);qt.x=p1.x;qt.y=p1.y;qt.z=p1.z;qt.w=p1.w;return qt}VS.QuaternionAdd<-function(p,q,qt=_QUAT):(Quaternion,QuaternionAlign){local q2=QuaternionAlign(p,q);qt.x=p.x+q2.x;qt.y=p.y+q2.y;qt.z=p.z+q2.z;qt.w=p.w+q2.w;return qt}VS.QuaternionDotProduct<-function(p,q){return p.x*q.x+p.y*q.y+p.z*q.z+p.w*q.w}VS.QuaternionInvert<-function(p,q){local r=p.x*p.x+p.y*p.y+p.z*p.z+p.w*p.w;if(r){local ir=1.0/r;q.x=-p.x*ir;q.y=-p.y*ir;q.z=-p.z*ir;q.w=p.w*ir}}VS.QuaternionBlendNoAlign<-function(p,q,t,qt=_QUAT):(QuaternionNormalize){local sclp=1.0-t,sclq=t;qt.x=sclp*p.x+sclq*q.x;qt.y=sclp*p.y+sclq*q.y;qt.z=sclp*p.z+sclq*q.z;qt.w=sclp*p.w+sclq*q.w;QuaternionNormalize(qt);return qt}local QuaternionBlendNoAlign=VS.QuaternionBlendNoAlign;VS.QuaternionBlend<-function(p,q,t,qt=_QUAT):(QuaternionAlign,QuaternionBlendNoAlign){return QuaternionBlendNoAlign(p,QuaternionAlign(p,q),t,qt)}VS.QuaternionIdentityBlend<-function(p,t,qt=_QUAT):(QuaternionNormalize){local sclp=1.0-t;qt.x=p.x*sclp;qt.y=p.y*sclp;qt.z=p.z*sclp;if(qt.w<0.0)qt.w=p.w*sclp-t;else qt.w=p.w*sclp+t;QuaternionNormalize(qt);return qt}VS.QuaternionSlerpNoAlign<-function(p,q,t,qt=_QUAT):(sin,acos){local sp,sq,cm=p.x*q.x+p.y*q.y+p.z*q.z+p.w*q.w;if(cm>-0.999999){if(cm<0.999999){local om=acos(cm),iv=1.0/sin(om);sp=sin((1.0-t)*om)*iv;sq=sin(t*om)*iv}else{sp=1.0-t;sq=t};qt.x=sp*p.x+sq*q.x;qt.y=sp*p.y+sq*q.y;qt.z=sp*p.z+sq*q.z;qt.w=sp*p.w+sq*q.w}else{sp=sin((1.0-t)*PIDIV2);sq=sin(t*PIDIV2);qt.x=sp*p.x-sq*q.y;qt.y=sp*p.y+sq*q.x;qt.z=sp*p.z-sq*q.w;qt.w=sp*p.w+sq*q.z};return qt}local QuaternionSlerpNoAlign=VS.QuaternionSlerpNoAlign;VS.QuaternionSlerp<-function(p,q,t,qt=_QUAT):(QuaternionAlign,QuaternionSlerpNoAlign){return QuaternionSlerpNoAlign(p,QuaternionAlign(p,q),t,qt)}VS.QuaternionExp<-function(p,q):(sqrt,sin,cos){local t=sqrt(p.x*q.x+p.y*q.y+p.z*q.z);if(t>FLT_EPSILON){local z=sin(t),S=z/t;q.x=S*p.x;q.y=S*p.y;q.z=S*p.z}else{q.x=p.x;q.y=p.y;q.z=p.z};q.w=cos(t)}VS.QuaternionLn<-function(p,q):(acos,sin){if(p.w>0.99999||-0.99999>p.w){local t=acos(p.w),S=t/sin(t);q.x=S*p.x;q.y=S*p.y;q.z=S*p.z}else{q.x=p.x;q.y=p.y;q.z=p.z};q.w=0.0}VS.QuaternionSquad<-function(Q0,Q1,Q2,Q3,T,out):(Quaternion,QuaternionSlerpNoAlign){local aQ12x=Q1.x+Q2.x,aQ12y=Q1.y+Q2.y,aQ12z=Q1.z+Q2.z,aQ12w=Q1.w+Q2.w,LS12=aQ12x*aQ12x+aQ12y*aQ12y+aQ12z*aQ12z+aQ12w*aQ12w,sQ12x=Q1.x-Q2.x,sQ12y=Q1.y-Q2.y,sQ12z=Q1.z-Q2.z,sQ12w=Q1.w-Q2.w,LD12=sQ12x*sQ12x+sQ12y*sQ12y+sQ12z*sQ12z+sQ12w*sQ12w,SQ2;if(LS12<LD12)SQ2=Quaternion(-Q2.x,-Q2.y,-Q2.z,-Q2.w);else SQ2=Q2;local aQ01x=Q0.x+Q1.x,aQ01y=Q0.y+Q1.y,aQ01z=Q0.z+Q1.z,aQ01w=Q0.w+Q1.w,LS01=aQ01x*aQ01x+aQ01y*aQ01y+aQ01z*aQ01z+aQ01w*aQ01w,sQ01x=Q0.x-Q1.x,sQ01y=Q0.y-Q1.y,sQ01z=Q0.z-Q1.z,sQ01w=Q0.w-Q1.w,LD01=sQ01x*sQ01x+sQ01y*sQ01y+sQ01z*sQ01z+sQ01w*sQ01w,SQ0;if(LS01<LD01)SQ0=Quaternion(-Q0.x,-Q0.y,-Q0.z,-Q0.w);else SQ0=Q0;local aQ23x=Q2.x+Q3.x,aQ23y=Q2.y+Q3.y,aQ23z=Q2.z+Q3.z,aQ23w=Q2.w+Q3.w,LS23=aQ23x*aQ23x+aQ23y*aQ23y+aQ23z*aQ23z+aQ23w*aQ23w,sQ23x=Q2.x-Q3.x,sQ23y=Q2.y-Q3.y,sQ23z=Q2.z-Q3.z,sQ23w=Q2.w-Q3.w,LD23=sQ23x*sQ23x+sQ23y*sQ23y+sQ23z*sQ23z+sQ23w*sQ23w,SQ3;if(LS23<LD23)SQ3=Quaternion(-Q3.x,-Q3.y,-Q3.z,-Q3.w);else SQ3=Q3;local InvQ1=Quaternion(),InvQ2=Quaternion();QuaternionInvert(Q1,InvQ1);QuaternionInvert(Q2,InvQ2);local LnQ0=Quaternion(InvQ1.x*SQ0.w+InvQ1.y*SQ0.z-InvQ1.z*SQ0.y+InvQ1.w*SQ0.x,-InvQ1.x*SQ0.z+InvQ1.y*SQ0.w+InvQ1.z*SQ0.x+InvQ1.w*SQ0.y,InvQ1.x*SQ0.y-InvQ1.y*SQ0.x+InvQ1.z*SQ0.w+InvQ1.w*SQ0.z,-InvQ1.x*SQ0.x-InvQ1.y*SQ0.y-InvQ1.z*SQ0.z+InvQ1.w*SQ0.w),LnQ2=Quaternion(InvQ1.x*SQ2.w+InvQ1.y*SQ2.z-InvQ1.z*SQ2.y+InvQ1.w*SQ2.x,-InvQ1.x*SQ2.z+InvQ1.y*SQ2.w+InvQ1.z*SQ2.x+InvQ1.w*SQ2.y,InvQ1.x*SQ2.y-InvQ1.y*SQ2.x+InvQ1.z*SQ2.w+InvQ1.w*SQ2.z,-InvQ1.x*SQ2.x-InvQ1.y*SQ2.y-InvQ1.z*SQ2.z+InvQ1.w*SQ2.w),LnQ1=Quaternion(InvQ2.x*Q1.w+InvQ2.y*Q1.z-InvQ2.z*Q1.y+InvQ2.w*Q1.x,-InvQ2.x*Q1.z+InvQ2.y*Q1.w+InvQ2.z*Q1.x+InvQ2.w*Q1.y,InvQ2.x*Q1.y-InvQ2.y*Q1.x+InvQ2.z*Q1.w+InvQ2.w*Q1.z,-InvQ2.x*Q1.x-InvQ2.y*Q1.y-InvQ2.z*Q1.z+InvQ2.w*Q1.w),LnQ3=Quaternion(InvQ2.x*SQ3.w+InvQ2.y*SQ3.z-InvQ2.z*SQ3.y+InvQ2.w*SQ3.x,-InvQ2.x*SQ3.z+InvQ2.y*SQ3.w+InvQ2.z*SQ3.x+InvQ2.w*SQ3.y,InvQ2.x*SQ3.y-InvQ2.y*SQ3.x+InvQ2.z*SQ3.w+InvQ2.w*SQ3.z,-InvQ2.x*SQ3.x-InvQ2.y*SQ3.y-InvQ2.z*SQ3.z+InvQ2.w*SQ3.w);QuaternionLn(LnQ0,LnQ0);QuaternionLn(LnQ2,LnQ2);QuaternionLn(LnQ1,LnQ1);QuaternionLn(LnQ3,LnQ3);local ExpQ02=Quaternion(-0.25*(LnQ0.x+LnQ2.x),-0.25*(LnQ0.y+LnQ2.y),-0.25*(LnQ0.z+LnQ2.z),-0.25*(LnQ0.w+LnQ2.w)),ExpQ13=Quaternion(-0.25*(LnQ1.x+LnQ3.x),-0.25*(LnQ1.y+LnQ3.y),-0.25*(LnQ1.z+LnQ3.z),-0.25*(LnQ1.w+LnQ3.w));QuaternionExp(ExpQ02,ExpQ02);QuaternionExp(ExpQ13,ExpQ13);local pA=Quaternion(Q1.x*ExpQ02.w+Q1.y*ExpQ02.z-Q1.z*ExpQ02.y+Q1.w*ExpQ02.x,-Q1.x*ExpQ02.z+Q1.y*ExpQ02.w+Q1.z*ExpQ02.x+Q1.w*ExpQ02.y,Q1.x*ExpQ02.y-Q1.y*ExpQ02.x+Q1.z*ExpQ02.w+Q1.w*ExpQ02.z,-Q1.x*ExpQ02.x-Q1.y*ExpQ02.y-Q1.z*ExpQ02.z+Q1.w*ExpQ02.w),pB=Quaternion(SQ2.x*ExpQ13.w+SQ2.y*ExpQ13.z-SQ2.z*ExpQ13.y+SQ2.w*ExpQ13.x,-SQ2.x*ExpQ13.z+SQ2.y*ExpQ13.w+SQ2.z*ExpQ13.x+SQ2.w*ExpQ13.y,SQ2.x*ExpQ13.y-SQ2.y*ExpQ13.x+SQ2.z*ExpQ13.w+SQ2.w*ExpQ13.z,-SQ2.x*ExpQ13.x-SQ2.y*ExpQ13.y-SQ2.z*ExpQ13.z+SQ2.w*ExpQ13.w);local pC=SQ2,Q0=Q1,Q1=pA,Q2=pB,Q3=pC,Q03=Quaternion(),Q12=Quaternion();QuaternionSlerpNoAlign(Q0,Q3,T,Q03);QuaternionSlerpNoAlign(Q1,Q2,T,Q12);T=(T-T*T)*2.0;QuaternionSlerpNoAlign(Q03,Q12,T,out)}VS.QuaternionAverageExponential<-function(q,c,P):(Quaternion){local p=P[0];if(c==1){q.x=p.x;q.y=p.y;q.z=p.z;q.w=p.w;return};local w=1.0/c,sum=Quaternion(),tmp=Quaternion();for(local i=0;i<c;++i){QuaternionAlign(p,P[i],tmp);QuaternionLn(tmp,tmp);sum.x+=tmp.x*w;sum.y+=tmp.y*w;sum.z+=tmp.z*w;sum.w+=tmp.w*w}QuaternionExp(sum,q)}VS.QuaternionAngleDiff<-function(p,q):(Quaternion,QuaternionMult,sqrt,asin){local i=Quaternion(-q.x,-q.y,-q.z,q.w),d=QuaternionMult(p,i),s=sqrt(d.x*d.x+d.y*d.y+d.z*d.z);if(s>1.0)s=1.0;return asin(s)*RAD2DEG2}VS.QuaternionScale<-function(p,t,q):(Vector,sqrt,sin,asin){local qv=Vector(p.x,p.y,p.z),om=qv.Length();if(om>1.0)om=1.0;local sm=sin(asin(om)*t);t=sm/(om+FLT_EPSILON);VectorScale(qv,t,q);local r=1.0-sm*sm;if(r<0.0)r=0.0;r=sqrt(r);if(0.0>p.w)q.w=-r;else q.w=r}VS.RotationDeltaAxisAngle<-function(sA,dA,dtX,dtA):(Quaternion){local sq=Quaternion(),dq=Quaternion(),si=Quaternion(),out=Quaternion();AngleQuaternion(sA,sq);AngleQuaternion(dA,dq);QuaternionScale(sq,-1.0,si);QuaternionMult(dq,si,out);QuaternionNormalize(out);QuaternionAxisAngle(out,dtX,dtA)}VS.RotationDelta<-function(sA,dA,out):(matrix3x4_t){local src=matrix3x4_t(),si=matrix3x4_t(),dst=matrix3x4_t(),xf=matrix3x4_t();AngleMatrix(sA,null,src);AngleMatrix(dA,null,dst);MatrixInvert(src,si);ConcatTransforms(dst,si,xf);MatrixAngles(dst,out)}VS.MatrixQuaternionFast<-function(m,q):(sqrt){m=m.m;local t;if(m[2][2]<0.0){if(m[0][0]>m[1][1]){t=1.0+m[0][0]-m[1][1]-m[2][2];q.x=t;q.y=m[0][1]+m[1][0];q.z=m[0][2]+m[2][0];q.w=m[2][1]-m[1][2]}else{t=1.0-m[0][0]+m[1][1]-m[2][2];q.x=m[0][1]+m[1][0];q.y=t;q.z=m[2][1]+m[1][2];q.w=m[0][2]-m[2][0]}}else{if(-m[1][1]>m[0][0]){t=1.0-m[0][0]-m[1][1]+m[2][2];q.x=m[0][2]+m[2][0];q.y=m[2][1]+m[1][2];q.z=t;q.w=m[1][0]-m[0][1]}else{t=1.0+m[0][0]+m[1][1]+m[2][2];q.x=m[2][1]-m[1][2];q.y=m[0][2]-m[2][0];q.z=m[1][0]-m[0][1];q.w=t}};local f=0.5/sqrt(t);q.x*=f;q.y*=f;q.z*=f;q.w*=f}local MatrixQuaternionFast=VS.MatrixQuaternionFast;VS.QuaternionMatrix<-function(q,T,m){m=m.m;local x=q.x,y=q.y,z=q.z,w=q.w,x2=x+x,y2=y+y,z2=z+z,xx=x*x2,xy=x*y2,xz=x*z2,yy=y*y2,yz=y*z2,zz=z*z2,wx=w*x2,wy=w*y2,wz=w*z2;m[0][0]=1.0-(yy+zz);m[1][0]=xy+wz;m[2][0]=xz-wy;m[0][1]=xy-wz;m[1][1]=1.0-(xx+zz);m[2][1]=yz+wx;m[0][2]=xz+wy;m[1][2]=yz-wx;m[2][2]=1.0-(xx+yy);if(T){m[0][3]=T.x;m[1][3]=T.y;m[2][3]=T.z}else m[0][3]=m[1][3]=m[2][3]=0.0}VS.QuaternionAngles2<-function(q,A=_VEC):(asin,atan2){local m11=(2.0*q.w*q.w)+(2.0*q.x*q.x)-1.0,m12=(2.0*q.x*q.y)+(2.0*q.w*q.z),m13=(2.0*q.x*q.z)-(2.0*q.w*q.y),m23=(2.0*q.y*q.z)+(2.0*q.w*q.x),m33=(2.0*q.w*q.w)+(2.0*q.z*q.z)-1.0;A.y=RAD2DEG*atan2(m12,m11);A.x=RAD2DEG*asin(-m13);A.z=RAD2DEG*atan2(m23,m33);return A}local QuaternionMatrix=VS.QuaternionMatrix;VS.QuaternionAngles<-function(q,A=_VEC):(matrix3x4_t,QuaternionMatrix,MatrixAngles){local m=matrix3x4_t();QuaternionMatrix(q,null,m);return MatrixAngles(m,A)}VS.QuaternionAxisAngle<-function(q,x):(acos){local a=acos(q.w)*RAD2DEG2;if(a>180.0)a-=360.0;x.x=q.x;x.y=q.y;x.z=q.z;x.Norm();return a}VS.AxisAngleQuaternion<-function(x,a,q=_QUAT):(sin,cos){a*=DEG2RADDIV2;local s=sin(a);q.x=x.x*s;q.y=x.y*s;q.z=x.z*s;q.w=cos(a);return q}VS.AngleQuaternion<-function(A,out=_QUAT):(sin,cos){local ay=A.y*DEG2RADDIV2,ax=A.x*DEG2RADDIV2,az=A.z*DEG2RADDIV2,sy=sin(ay),cy=cos(ay),sp=sin(ax),cp=cos(ax),sr=sin(az),cr=cos(az),srcp=sr*cp,crsp=cr*sp,crcp=cr*cp,srsp=sr*sp;out.x=srcp*cy-crsp*sy;out.y=crsp*cy+srcp*sy;out.z=crcp*sy-srsp*cy;out.w=crcp*cy+srsp*sy;return out}local AngleQuaternion=VS.AngleQuaternion;VS.MatrixQuaternion<-function(m,q=_QUAT):(AngleQuaternion,MatrixAngles){return AngleQuaternion(MatrixAngles(m),q)}VS.BasisToQuaternion<-function(F,R,U,q=_QUAT):(matrix3x4_t,MatrixQuaternionFast){MatrixQuaternionFast(matrix3x4_t(F.x,-R.x,U.x,0.0,F.y,-R.y,U.y,0.0,F.z,-R.z,U.z,0.0),q);return q}VS.MatricesAreEqual<-function(m1,m2,t){m1=m1.m;m2=m2.m;for(local i=3;i--;)for(local j=4;j--;){local f=m1[i][j]-m2[i][j];if(0.0>f)f=-f;if(f>t)return false}return true}VS.MatrixCopy<-function(src,dst){src=src.m;dst=dst.m;dst[0][0]=src[0][0];dst[0][1]=src[0][1];dst[0][2]=src[0][2];dst[0][3]=src[0][3];dst[1][0]=src[1][0];dst[1][1]=src[1][1];dst[1][2]=src[1][2];dst[1][3]=src[1][3];dst[2][0]=src[2][0];dst[2][1]=src[2][1];dst[2][2]=src[2][2];dst[2][3]=src[2][3]}VS.MatrixInvert<-function(in1,out){in1=in1.m;out=out.m;if(in1==out){local t=out[0][1];out[0][1]=out[1][0];out[1][0]=t;t=out[0][2];out[0][2]=out[2][0];out[2][0]=t;t=out[1][2];out[1][2]=out[2][1];out[2][1]=t}else{out[0][0]=in1[0][0];out[0][1]=in1[1][0];out[0][2]=in1[2][0];out[1][0]=in1[0][1];out[1][1]=in1[1][1];out[1][2]=in1[2][1];out[2][0]=in1[0][2];out[2][1]=in1[1][2];out[2][2]=in1[2][2]};local tx=in1[0][3],ty=in1[1][3],tz=in1[2][3];out[0][3]=-(tx*out[0][0]+ty*out[0][1]+tz*out[0][2]);out[1][3]=-(tx*out[1][0]+ty*out[1][1]+tz*out[1][2]);out[2][3]=-(tx*out[2][0]+ty*out[2][1]+tz*out[2][2])}VS.MatrixInverseGeneral<-function(src,dst):(array,fabs){local mat=array(4),rm=array(4,0);for(local i=4;i--;)mat[i]=array(8,0.0);src=src.m;for(local i=0;i<4;++i){local pIn=src[i],pOut=mat[i];pOut[0]=pIn[0];pOut[1]=pIn[1];pOut[2]=pIn[2];pOut[3]=pIn[3];pOut[4]=pOut[5]=pOut[6]=pOut[7]=0.0;pOut[i+4]=1.0;rm[i]=i}for(local iRow=0;iRow<4;++iRow){local lg=0.00001,il=0xFFFFFFFF;for(local ts=iRow;ts<4;++ts){local ft=fabs(mat[rm[ts]][iRow]);if(ft>lg){il=ts;lg=ft}}if(il==0xFFFFFFFF)return false;local tt=rm[il];rm[il]=rm[iRow];rm[iRow]=tt;local pRow=mat[rm[iRow]],mul=1.0/pRow[iRow];pRow[0]*=mul;pRow[1]*=mul;pRow[2]*=mul;pRow[3]*=mul;pRow[4]*=mul;pRow[5]*=mul;pRow[6]*=mul;pRow[7]*=mul;pRow[iRow]=1.0;for(local i=0;i<4;++i){if(i==iRow)continue;local sr=mat[rm[i]],mul=sr[iRow];sr[0]-=pRow[0]*mul;sr[1]-=pRow[1]*mul;sr[2]-=pRow[2]*mul;sr[3]-=pRow[3]*mul;sr[4]-=pRow[4]*mul;sr[5]-=pRow[5]*mul;sr[6]-=pRow[6]*mul;sr[7]-=pRow[7]*mul;sr[iRow]=0.0}}dst=dst.m;for(local i=0;i<4;++i){local pIn=mat[rm[i]],pOut=dst[i];pOut[0]=pIn[4];pOut[1]=pIn[5];pOut[2]=pIn[6];pOut[3]=pIn[7]}return true}VS.MatrixInverseTR<-function(src,dst){src=src.m;dst=dst.m;dst[0][0]=src[0][0];dst[0][1]=src[1][0];dst[0][2]=src[2][0];dst[1][0]=src[0][1];dst[1][1]=src[1][1];dst[1][2]=src[2][1];dst[2][0]=src[0][2];dst[2][1]=src[1][2];dst[2][2]=src[2][2];dst[0][3]=dst[0][0]*-src[0][3]-dst[0][1]*src[1][3]-dst[0][2]*src[2][3];dst[1][3]=dst[1][0]*-src[0][3]-dst[1][1]*src[1][3]-dst[1][2]*src[2][3];dst[2][3]=dst[2][0]*-src[0][3]-dst[2][1]*src[1][3]-dst[2][2]*src[2][3];dst[3][0]=dst[3][1]=dst[3][2]=0.0;dst[3][3]=1.0}VS.MatrixGetColumn<-function(in1,col,out=_VEC){in1=in1.m;out.x=in1[0][col];out.y=in1[1][col];out.z=in1[2][col];return out}VS.MatrixSetColumn<-function(in1,col,out){out=out.m;out[0][col]=in1.x;out[1][col]=in1.y;out[2][col]=in1.z}VS.MatrixScaleBy<-function(scl,out){out=out.m;out[0][0]*=scl;out[1][0]*=scl;out[2][0]*=scl;out[0][1]*=scl;out[1][1]*=scl;out[2][1]*=scl;out[0][2]*=scl;out[1][2]*=scl;out[2][2]*=scl}VS.MatrixScaleByZero<-function(out){out=out.m;out[0][0]=out[1][0]=out[2][0]=out[0][1]=out[1][1]=out[2][1]=out[0][2]=out[1][2]=out[2][2]=0.0}VS.SetIdentityMatrix<-function(m){m=m.m;m[0][0]=m[1][1]=m[2][2]=1.0;m[0][1]=m[0][2]=m[0][3]=m[1][0]=m[1][2]=m[1][3]=m[2][0]=m[2][1]=m[2][3]=0.0}VS.SetScaleMatrix<-function(x,y,z,dst){dst=dst.m;dst[0][0]=x;dst[1][1]=y;dst[2][2]=z;dst[0][1]=dst[0][2]=dst[0][3]=dst[1][0]=dst[1][2]=dst[1][3]=dst[2][0]=dst[2][1]=dst[2][3]=0.0}VS.ComputeCenterMatrix<-function(org,ang,mins,maxs,m):(VectorRotate,AngleMatrix){AngleMatrix(ang,null,m);local lc=(mins+maxs)*0.5,wc=VectorRotate(lc,m)+org;m=m.m;m[0][3]=wc.x;m[1][3]=wc.y;m[2][3]=wc.z}VS.ComputeCenterIMatrix<-function(org,ang,mins,maxs,m):(VectorRotate,AngleIMatrix){AngleIMatrix(ang,null,m);local lo=VectorRotate(org,m),lc=(mins+maxs)*-0.5-lo;m=m.m;m[0][3]=lc.x;m[1][3]=lc.y;m[2][3]=lc.z}VS.ComputeAbsMatrix<-function(in1,out):(fabs){in1=in1.m;out=out.m;out[0][0]=fabs(in1[0][0]);out[0][1]=fabs(in1[0][1]);out[0][2]=fabs(in1[0][2]);out[1][0]=fabs(in1[1][0]);out[1][1]=fabs(in1[1][1]);out[1][2]=fabs(in1[1][2]);out[2][0]=fabs(in1[2][0]);out[2][1]=fabs(in1[2][1]);out[2][2]=fabs(in1[2][2])}VS.ConcatRotations<-function(in1,in2,out){in1=in1.m;in2=in2.m;out=out.m;out[0][0]=in1[0][0]*in2[0][0]+in1[0][1]*in2[1][0]+in1[0][2]*in2[2][0];out[0][1]=in1[0][0]*in2[0][1]+in1[0][1]*in2[1][1]+in1[0][2]*in2[2][1];out[0][2]=in1[0][0]*in2[0][2]+in1[0][1]*in2[1][2]+in1[0][2]*in2[2][2];out[1][0]=in1[1][0]*in2[0][0]+in1[1][1]*in2[1][0]+in1[1][2]*in2[2][0];out[1][1]=in1[1][0]*in2[0][1]+in1[1][1]*in2[1][1]+in1[1][2]*in2[2][1];out[1][2]=in1[1][0]*in2[0][2]+in1[1][1]*in2[1][2]+in1[1][2]*in2[2][2];out[2][0]=in1[2][0]*in2[0][0]+in1[2][1]*in2[1][0]+in1[2][2]*in2[2][0];out[2][1]=in1[2][0]*in2[0][1]+in1[2][1]*in2[1][1]+in1[2][2]*in2[2][1];out[2][2]=in1[2][0]*in2[0][2]+in1[2][1]*in2[1][2]+in1[2][2]*in2[2][2]}VS.ConcatTransforms<-function(in1,in2,out){in1=in1.m;in2=in2.m;out=out.m;local m00=in1[0][0]*in2[0][0]+in1[0][1]*in2[1][0]+in1[0][2]*in2[2][0],m01=in1[0][0]*in2[0][1]+in1[0][1]*in2[1][1]+in1[0][2]*in2[2][1],m02=in1[0][0]*in2[0][2]+in1[0][1]*in2[1][2]+in1[0][2]*in2[2][2],m03=in1[0][0]*in2[0][3]+in1[0][1]*in2[1][3]+in1[0][2]*in2[2][3],m10=in1[1][0]*in2[0][0]+in1[1][1]*in2[1][0]+in1[1][2]*in2[2][0],m11=in1[1][0]*in2[0][1]+in1[1][1]*in2[1][1]+in1[1][2]*in2[2][1],m12=in1[1][0]*in2[0][2]+in1[1][1]*in2[1][2]+in1[1][2]*in2[2][2],m13=in1[1][0]*in2[0][3]+in1[1][1]*in2[1][3]+in1[1][2]*in2[2][3],m20=in1[2][0]*in2[0][0]+in1[2][1]*in2[1][0]+in1[2][2]*in2[2][0],m21=in1[2][0]*in2[0][1]+in1[2][1]*in2[1][1]+in1[2][2]*in2[2][1],m22=in1[2][0]*in2[0][2]+in1[2][1]*in2[1][2]+in1[2][2]*in2[2][2],m23=in1[2][0]*in2[0][3]+in1[2][1]*in2[1][3]+in1[2][2]*in2[2][3];out[0][0]=m00;out[0][1]=m01;out[0][2]=m02;out[0][3]=m03;out[1][0]=m10;out[1][1]=m11;out[1][2]=m12;out[1][3]=m13;out[2][0]=m20;out[2][1]=m21;out[2][2]=m22;out[2][3]=m23}VS.MatrixMultiply<-function(in1,in2,out){in1=in1.m;in2=in2.m;out=out.m;local m00=in1[0][0]*in2[0][0]+in1[0][1]*in2[1][0]+in1[0][2]*in2[2][0]+in1[0][3]*in2[3][0],m01=in1[0][0]*in2[0][1]+in1[0][1]*in2[1][1]+in1[0][2]*in2[2][1]+in1[0][3]*in2[3][1],m02=in1[0][0]*in2[0][2]+in1[0][1]*in2[1][2]+in1[0][2]*in2[2][2]+in1[0][3]*in2[3][2],m03=in1[0][0]*in2[0][3]+in1[0][1]*in2[1][3]+in1[0][2]*in2[2][3]+in1[0][3]*in2[3][3],m10=in1[1][0]*in2[0][0]+in1[1][1]*in2[1][0]+in1[1][2]*in2[2][0]+in1[1][3]*in2[3][0],m11=in1[1][0]*in2[0][1]+in1[1][1]*in2[1][1]+in1[1][2]*in2[2][1]+in1[1][3]*in2[3][1],m12=in1[1][0]*in2[0][2]+in1[1][1]*in2[1][2]+in1[1][2]*in2[2][2]+in1[1][3]*in2[3][2],m13=in1[1][0]*in2[0][3]+in1[1][1]*in2[1][3]+in1[1][2]*in2[2][3]+in1[1][3]*in2[3][3],m20=in1[2][0]*in2[0][0]+in1[2][1]*in2[1][0]+in1[2][2]*in2[2][0]+in1[2][3]*in2[3][0],m21=in1[2][0]*in2[0][1]+in1[2][1]*in2[1][1]+in1[2][2]*in2[2][1]+in1[2][3]*in2[3][1],m22=in1[2][0]*in2[0][2]+in1[2][1]*in2[1][2]+in1[2][2]*in2[2][2]+in1[2][3]*in2[3][2],m23=in1[2][0]*in2[0][3]+in1[2][1]*in2[1][3]+in1[2][2]*in2[2][3]+in1[2][3]*in2[3][3],m30=in1[3][0]*in2[0][0]+in1[3][1]*in2[1][0]+in1[3][2]*in2[2][0]+in1[3][3]*in2[3][0],m31=in1[3][0]*in2[0][1]+in1[3][1]*in2[1][1]+in1[3][2]*in2[2][1]+in1[3][3]*in2[3][1],m32=in1[3][0]*in2[0][2]+in1[3][1]*in2[1][2]+in1[3][2]*in2[2][2]+in1[3][3]*in2[3][2],m33=in1[3][0]*in2[0][3]+in1[3][1]*in2[1][3]+in1[3][2]*in2[2][3]+in1[3][3]*in2[3][3];out[0][0]=m00;out[0][1]=m01;out[0][2]=m02;out[0][3]=m03;out[1][0]=m10;out[1][1]=m11;out[1][2]=m12;out[1][3]=m13;out[2][0]=m20;out[2][1]=m21;out[2][2]=m22;out[2][3]=m23;out[3][0]=m30;out[3][1]=m31;out[3][2]=m32;out[3][3]=m33}VS.MatrixBuildRotationAboutAxis<-function(X,A,dst):(sin,cos){local r=A*DEG2RAD,s=sin(r),c=cos(r),xx=X.x*X.x,yy=X.y*X.y,zz=X.z*X.z,xyc=X.x*X.y*c,yzc=X.y*X.z*c,xzc=X.z*X.x*c,xs=X.x*s,ys=X.y*s,zs=X.z*s;dst=dst.m;dst[0][0]=xx+(1.0-xx)*c;dst[1][1]=yy+(1.0-yy)*c;dst[2][2]=zz+(1.0-zz)*c;c=1.0-c;dst[1][0]=xyc+zs;dst[2][0]=xzc-ys;dst[0][1]=xyc-zs;dst[2][1]=yzc+xs;dst[0][2]=xzc+ys;dst[1][2]=yzc-xs;dst[0][3]=dst[1][3]=dst[2][3]=0.0}local MatrixBuildRotationAboutAxis=VS.MatrixBuildRotationAboutAxis;VS.MatrixBuildRotation<-function(dst,dir1,dir2):(Vector,fabs,acos,MatrixBuildRotationAboutAxis){local x,a=dir1.Dot(dir2);if(a>0.999)return SetIdentityMatrix(dst);else if(-0.999>a){local i="x";if(fabs(dir2.y)<fabs(dir2[i]))i="y";if(fabs(dir2.z)<fabs(dir2[i]))i="z";x=Vector();x[i]=1.0;local t=-x.Dot(dir2);x.x+=dir2.x*t;x.y+=dir2.y*t;x.z+=dir2.z*t;x.Norm();a=180.0}else{x=dir1.Cross(dir2);x.Norm();a=acos(a)*RAD2DEG};;return MatrixBuildRotationAboutAxis(x,a,dst)}VS.Vector3DMultiplyProjective<-function(src1,src2,dst){src1=src1.m;local iw=1.0/(src1[3][0]*src2.x+src1[3][1]*src2.y+src1[3][2]*src2.z),x=iw*(src1[0][0]*src2.x+src1[0][1]*src2.y+src1[0][2]*src2.z),y=iw*(src1[1][0]*src2.x+src1[1][1]*src2.y+src1[1][2]*src2.z),z=iw*(src1[2][0]*src2.x+src1[2][1]*src2.y+src1[2][2]*src2.z);dst.x=x;dst.y=y;dst.z=z}VS.Vector3DMultiplyPositionProjective<-function(src1,src2,dst){src1=src1.m;local iw=1.0/(src1[3][0]*src2.x+src1[3][1]*src2.y+src1[3][2]*src2.z+src1[3][3]),x=iw*(src1[0][0]*src2.x+src1[0][1]*src2.y+src1[0][2]*src2.z+src1[0][3]),y=iw*(src1[1][0]*src2.x+src1[1][1]*src2.y+src1[1][2]*src2.z+src1[1][3]),z=iw*(src1[2][0]*src2.x+src1[2][1]*src2.y+src1[2][2]*src2.z+src1[2][3]);dst.x=x;dst.y=y;dst.z=z}VS.TransformAABB<-function(mat,ni,xi,io,xo):(Vector,fabs,VectorAdd,VectorSubtract,VectorTransform){local lc=(ni+xi)*0.5,le=xi-lc,wc=VectorTransform(lc,mat);mat=mat.m;local we=Vector(fabs(le.x*mat[0][0])+fabs(le.y*mat[0][1])+fabs(le.z*mat[0][2]),fabs(le.x*mat[1][0])+fabs(le.y*mat[1][1])+fabs(le.z*mat[1][2]),fabs(le.x*mat[2][0])+fabs(le.y*mat[2][1])+fabs(le.z*mat[2][2]));VectorSubtract(wc,we,io);VectorAdd(wc,we,xo)}VS.ITransformAABB<-function(mat,ni,xi,io,xo):(Vector,fabs,VectorAdd,VectorSubtract,VectorITransform){local wc=(ni+xi)*0.5,we=xi-wc,lc=VectorITransform(wc,mat);mat=mat.m;local le=Vector(fabs(we.x*mat[0][0])+fabs(we.y*mat[1][0])+fabs(we.z*mat[2][0]),fabs(we.x*mat[0][1])+fabs(we.y*mat[1][1])+fabs(we.z*mat[2][1]),fabs(we.x*mat[0][2])+fabs(we.y*mat[1][2])+fabs(we.z*mat[2][2]));VectorSubtract(lc,le,io);VectorAdd(lc,le,xo)}VS.RotateAABB<-function(mat,ni,xi,io,xo):(Vector,fabs,VectorAdd,VectorSubtract,VectorRotate){local lc=(ni+xi)*0.5,le=xi-lc,nc=VectorRotate(lc,mat);mat=mat.m;local ne=Vector(fabs(le.x*mat[0][0])+fabs(le.y*mat[0][1])+fabs(le.z*mat[0][2]),fabs(le.x*mat[1][0])+fabs(le.y*mat[1][1])+fabs(le.z*mat[1][2]),fabs(le.x*mat[2][0])+fabs(le.y*mat[2][1])+fabs(le.z*mat[2][2]));VectorSubtract(nc,ne,io);VectorAdd(nc,ne,xo)}VS.IRotateAABB<-function(mat,ni,xi,io,xo):(Vector,fabs,VectorAdd,VectorSubtract,VectorIRotate){local oc=(ni+xi)*0.5,oe=xi-oc,nc=VectorIRotate(oc,mat);mat=mat.m;local ne=Vector(fabs(oe.x*mat[0][0])+fabs(oe.y*mat[1][0])+fabs(oe.z*mat[2][0]),fabs(oe.x*mat[0][1])+fabs(oe.y*mat[1][1])+fabs(oe.z*mat[2][1]),fabs(oe.x*mat[0][2])+fabs(oe.y*mat[1][2])+fabs(oe.z*mat[2][2]));VectorSubtract(nc,ne,io);VectorAdd(nc,ne,xo)}VS.GetBoxVertices<-function(o,a,n,x,p):(matrix3x4_t,Vector,VectorAdd,VectorRotate,AngleMatrix){local r=matrix3x4_t();AngleMatrix(a,null,r);local v=p[0];v.x=n.x;v.y=n.y;v.z=n.z;VectorRotate(v,r,v);VectorAdd(v,o,v);v=p[1];v.x=x.x;v.y=n.y;v.z=n.z;VectorRotate(v,r,v);VectorAdd(v,o,v);v=p[2];v.x=n.x;v.y=x.y;v.z=n.z;VectorRotate(v,r,v);VectorAdd(v,o,v);v=p[3];v.x=x.x;v.y=x.y;v.z=n.z;VectorRotate(v,r,v);VectorAdd(v,o,v);v=p[4];v.x=n.x;v.y=n.y;v.z=x.z;VectorRotate(v,r,v);VectorAdd(v,o,v);v=p[5];v.x=x.x;v.y=n.y;v.z=x.z;VectorRotate(v,r,v);VectorAdd(v,o,v);v=p[6];v.x=n.x;v.y=x.y;v.z=x.z;VectorRotate(v,r,v);VectorAdd(v,o,v);v=p[7];v.x=x.x;v.y=x.y;v.z=x.z;VectorRotate(v,r,v);VectorAdd(v,o,v)}VS.MatrixBuildPerspective<-function(dst,fx,fa,zN,zF):(tan){dst=dst.m;dst[0][1]=dst[0][3]=dst[1][0]=dst[1][3]=dst[2][0]=dst[2][1]=dst[3][0]=dst[3][1]=dst[3][3]=0.0;local w=-0.5/tan(fx*DEG2RADDIV2),r=zF/(zN-zF);dst[0][0]=w;dst[1][1]=w*fa;dst[0][2]=dst[1][2]=0.5;dst[2][2]=-r;dst[3][2]=1.0;dst[2][3]=zN*r}VS.ComputeViewMatrix<-function(w2v,T,F,L,U):(Vector,matrix3x4_t,VMatrix){local r=matrix3x4_t();MatrixSetColumn(F,0,r);MatrixSetColumn(L,1,r);MatrixSetColumn(U,2,r);MatrixSetColumn(T,3,r);local m=VMatrix();MatrixCopy(r,m);local rz=VMatrix();MatrixBuildRotationAboutAxis(Vector(0,0,1),-90,rz);MatrixMultiply(m,rz,m);local rx=VMatrix();MatrixBuildRotationAboutAxis(Vector(1,0,0),90,rx);MatrixMultiply(m,rx,m);MatrixCopy(m,r);MatrixInvert(r,r);MatrixCopy(r,w2v)}VS.ComputeCameraVariables<-function(T,F,R,U,m){m=m.m;m[0][0]=-R.x;m[0][1]=-R.y;m[0][2]=-R.z;m[0][3]=R.Dot(T);m[1][0]=-U.x;m[1][1]=-U.y;m[1][2]=-U.z;m[1][3]=U.Dot(T);m[2][0]=F.x;m[2][1]=F.y;m[2][2]=F.z;m[2][3]=-F.Dot(T);m[3][0]=m[3][1]=m[3][2]=0.0;m[3][3]=1.0}VS.ScreenToWorld<-function(x,y,O,F,R,U,v,a,zF):(Vector,VMatrix){local scr=Vector(x,1.0-y,1.0),v2p=VMatrix(),w2v=VMatrix();MatrixBuildPerspective(v2p,v,a,1.0,zF);ComputeCameraVariables(O,F,R,U,w2v);MatrixMultiply(v2p,w2v,v2p);MatrixInverseGeneral(v2p,w2v);local wp=Vector();Vector3DMultiplyPositionProjective(w2v,scr,wp);return wp}VS.CalcFovY<-function(f,a):(tan,atan){if(f<1.0||f>179.0)f=90.0;return RAD2DEG2*atan(tan(DEG2RADDIV2*f)/a)}VS.CalcFovX<-function(f,a):(tan,atan){return RAD2DEG2*atan(tan(DEG2RADDIV2*f)*a)}local inFD=function(){local Line=DebugDrawLine,V3MPP=VS.Vector3DMultiplyPositionProjective,MatrixInverseGeneral=VS.MatrixInverseGeneral,MatrixBuildPerspective=VS.MatrixBuildPerspective,ws1=Vector(),ws2=Vector();local draw=function(ls1,ls2,mat,r,g,b,z,t):(Vector,V3MPP,Line,ws1,ws2){V3MPP(mat,ls1,ws1);V3MPP(mat,ls2,ws2);return Line(ws1,ws2,r,g,b,z,t)},v000=Vector(),v001=Vector(0.0,0.0,1.0),v011=Vector(0.0,1.0,1.0),v010=Vector(0.0,1.0,0.0),v010=Vector(0.0,1.0,0.0),v100=Vector(1.0,0.0,0.0),v101=Vector(1.0,0.0,1.0),v111=Vector(1.0,1.0,1.0),v110=Vector(1.0,1.0,0.0);local fr=[v000,v001,v001,v011,v011,v010,v010,v000,v100,v101,v101,v111,v111,v110,v110,v100,v000,v100,v001,v101,v011,v111,v010,v110],v2w=VMatrix();VS.DrawFrustum<-function(w2v,r,g,b,z,t):(MatrixInverseGeneral,draw,fr,v2w){MatrixInverseGeneral(w2v,v2w);draw(fr[0],fr[1],v2w,r,g,b,z,t);draw(fr[2],fr[3],v2w,r,g,b,z,t);draw(fr[4],fr[5],v2w,r,g,b,z,t);draw(fr[6],fr[7],v2w,r,g,b,z,t);draw(fr[8],fr[9],v2w,r,g,b,z,t);draw(fr[10],fr[11],v2w,r,g,b,z,t);draw(fr[12],fr[13],v2w,r,g,b,z,t);draw(fr[14],fr[15],v2w,r,g,b,z,t);draw(fr[16],fr[17],v2w,r,g,b,z,t);draw(fr[18],fr[19],v2w,r,g,b,z,t);draw(fr[20],fr[21],v2w,r,g,b,z,t);draw(fr[22],fr[23],v2w,r,g,b,z,t)}local DrawFrustum=VS.DrawFrustum;VS.DrawViewFrustum<-function(O,F,R,U,v,a,zN,zF,r,g,b,z,t):(VMatrix,MatrixBuildPerspective,ComputeCameraVariables,MatrixMultiply,DrawFrustum){local mp=VMatrix(),mc=VMatrix();MatrixBuildPerspective(mp,v,a,zN,zF);ComputeCameraVariables(O,F,R,U,mc);MatrixMultiply(mp,mc,mp);return DrawFrustum(mp,r,g,b,z,t)}}VS.DrawFrustum<-function(m,r,g,b,z,t):(inFD){inFD();return DrawFrustum(m,r,g,b,z,t)}VS.DrawViewFrustum<-function(O,F,R,U,v,a,zN,zF,r,g,b,z,t):(inFD){inFD();return DrawViewFrustum(O,F,R,U,v,a,zN,zF,r,g,b,z,t)}local inBD=function(){local Box=DebugDrawBox,Line=DebugDrawLine,GetBoxVertices=VS.GetBoxVertices,pV=[Vector(),Vector(),Vector(),Vector(),Vector(),Vector(),Vector(),Vector()];VS.DrawBoxAngles<-function(o,n,x,a,r,g,b,z,t):(pV,GetBoxVertices,Line){GetBoxVertices(o,a,n,x,pV);local v0=pV[0],v1=pV[1],v2=pV[2],v3=pV[3],v4=pV[4],v5=pV[5],v6=pV[6],v7=pV[7];Line(v0,v1,r,g,b,z,t);Line(v0,v2,r,g,b,z,t);Line(v1,v3,r,g,b,z,t);Line(v2,v3,r,g,b,z,t);Line(v0,v4,r,g,b,z,t);Line(v1,v5,r,g,b,z,t);Line(v2,v6,r,g,b,z,t);Line(v3,v7,r,g,b,z,t);Line(v5,v7,r,g,b,z,t);Line(v5,v4,r,g,b,z,t);Line(v4,v6,r,g,b,z,t);Line(v7,v6,r,g,b,z,t)}VS.DrawEntityBounds<-function(h,r,g,b,z,t):(Box){local o=h.GetOrigin(),a=h.GetAngles(),n=h.GetBoundingMins(),x=h.GetBoundingMaxs();if(!a.x&&!a.y&&!a.z){Box(o,n,x,r,g,b,0,t)}else{DrawBoxAngles(o,n,x,a,r,g,b,z,t)}}}VS.DrawBoxAngles<-function(o,n,x,a,r,g,b,z,t):(inBD){inBD();return DrawBoxAngles(o,n,x,a,r,g,b,z,t)}VS.DrawEntityBounds<-function(h,r,g,b,z,t):(inBD){inBD();return DrawEntityBounds(h,r,g,b,z,t)}local Line=DebugDrawLine;VS.DrawSphere<-function(org,rad,nth,nph,r,g,b,z,t):(array,Vector,sin,cos,Line){++nth;local pV=array(nph*nth),i,j,c=0;for(i=0;i<nph;++i)for(j=0;j<nth;++j){local u=j/(nth-1).tofloat(),v=i/(nph-1).tofloat();local th=PI2*u,ph=PI*v;local sp=rad*sin(ph);pV[c++]=Vector(org.x+(sp*cos(th)),org.y+(sp*sin(th)),org.z+(rad*cos(ph)))}for(i=0;i<nph-1;++i)for(j=0;j<nth-1;++j){local x=nth*i+j;Line(pV[x],pV[x+nth],r,g,b,z,t);Line(pV[x],pV[x+1],r,g,b,z,t)}}local inCP=function(){local Line=DebugDrawLine,cvp=[[-0.01,-0.01,1.0],[0.51,0.0,0.86],[0.44,0.25,0.86],[0.25,0.44,0.86],[-0.01,0.51,0.86],[-0.26,0.44,0.86],[-0.45,0.25,0.86],[-0.51,0.0,0.86],[-0.45,-0.26,0.86],[-0.26,-0.45,0.86],[-0.01,-0.51,0.86],[0.25,-0.45,0.86],[0.44,-0.26,0.86],[0.86,0.0,0.51],[0.75,0.43,0.51],[0.43,0.75,0.51],[-0.01,0.86,0.51],[-0.44,0.75,0.51],[-0.76,0.43,0.51],[-0.87,0.0,0.51],[-0.76,-0.44,0.51],[-0.44,-0.76,0.51],[-0.01,-0.87,0.51],[0.43,-0.76,0.51],[0.75,-0.44,0.51],[1.0,0.0,0.01],[0.86,0.5,0.01],[0.49,0.86,0.01],[-0.01,1.0,0.01],[-0.51,0.86,0.01],[-0.87,0.5,0.01],[-1.0,0.0,0.01],[-0.87,-0.5,0.01],[-0.51,-0.87,0.01],[-0.01,-1.0,0.01],[0.49,-0.87,0.01],[0.86,-0.51,0.01],[1.0,0.0,-0.02],[0.86,0.5,-0.02],[0.49,0.86,-0.02],[-0.01,1.0,-0.02],[-0.51,0.86,-0.02],[-0.87,0.5,-0.02],[-1.0,0.0,-0.02],[-0.87,-0.5,-0.02],[-0.51,-0.87,-0.02],[-0.01,-1.0,-0.02],[0.49,-0.87,-0.02],[0.86,-0.51,-0.02],[0.86,0.0,-0.51],[0.75,0.43,-0.51],[0.43,0.75,-0.51],[-0.01,0.86,-0.51],[-0.44,0.75,-0.51],[-0.76,0.43,-0.51],[-0.87,0.0,-0.51],[-0.76,-0.44,-0.51],[-0.44,-0.76,-0.51],[-0.01,-0.87,-0.51],[0.43,-0.76,-0.51],[0.75,-0.44,-0.51],[0.51,0.0,-0.87],[0.44,0.25,-0.87],[0.25,0.44,-0.87],[-0.01,0.51,-0.87],[-0.26,0.44,-0.87],[-0.45,0.25,-0.87],[-0.51,0.0,-0.87],[-0.45,-0.26,-0.87],[-0.26,-0.45,-0.87],[-0.01,-0.51,-0.87],[0.25,-0.45,-0.87],[0.44,-0.26,-0.87],[0.0,0.0,-1.0]],cli=[-1,14,0,4,16,28,40,52,64,73,70,58,46,34,22,10,-1,14,0,1,13,25,37,49,61,73,67,55,43,31,19,7,-1,12,61,62,63,64,65,66,67,68,69,70,71,72,-1,12,49,50,51,52,53,54,55,56,57,58,59,60,-1,12,37,38,39,40,41,42,43,44,45,46,47,48,-1,12,25,26,27,28,29,30,31,32,33,34,35,36,-1,12,13,14,15,16,17,18,19,20,21,22,23,24,-1,12,1,2,3,4,5,6,7,8,9,10,11,12,-1],cv=array(74);VS.DrawCapsule<-function(v1,v2,R,r,g,b,z,t):(cvp,cli,cv,Line,Vector,matrix3x4_t){local vl=v2-v1;for(local i=0;i<74;++i){local vt=Vector(cvp[i][0],cvp[i][1],cvp[i][2]);vt*=R;if(cvp[i][2]>0.0)vt+=vl;cv[i]=vt+v1}local i=0;while(i<117){local i0=cli[i];if(i0==0xFFFFFFFF){i+=2;continue};local i1=cli[++i];if(i1==0xFFFFFFFF){i+=2;if(i>116)break;continue};Line(cv[i0],cv[i1],r,g,b,z,t)}}}VS.DrawCapsule<-function(v1,v2,R,r,g,b,z,t):(inCP){inCP();return DrawCapsule(v1,v2,R,r,g,b,z,t)}{local QuaternionAngles=VS.QuaternionAngles,QuaternionSlerp=VS.QuaternionSlerp,VectorMA=VS.VectorMA,VectorLerp=VS.VectorLerp;enum INTERPOLATE{DEFAULT,CATMULL_ROM_NORMALIZEX,EASE_IN,EASE_OUT,EASE_INOUT,BSPLINE,LINEAR_INTERP,KOCHANEK_BARTELS,KOCHANEK_BARTELS_EARLY,KOCHANEK_BARTELS_LATE,SIMPLE_CUBIC,CATMULL_ROM,CATMULL_ROM_NORMALIZE,CATMULL_ROM_TANGENT,EXPONENTIAL_DECAY,HOLD}VS.Interpolator_GetKochanekBartelsParams<-function(i,tbc){switch(i){case INTERPOLATE.KOCHANEK_BARTELS:tbc[0]=0.77;tbc[1]=0.0;tbc[2]=0.77;break;case INTERPOLATE.KOCHANEK_BARTELS_EARLY:tbc[0]=0.77;tbc[1]=-1.0;tbc[2]=0.77;break;case INTERPOLATE.KOCHANEK_BARTELS_LATE:tbc[0]=0.77;tbc[1]=1.0;tbc[2]=0.77;break;default:tbc[0]=tbc[1]=tbc[2]=0.0;break}}VS.Interpolator_CurveInterpolate<-function(i,p0,p1,p2,p3,f,o):(sin){o.x=o.y=o.z=0.0;switch(i){case INTERPOLATE.DEFAULT:case INTERPOLATE.CATMULL_ROM_NORMALIZEX:Catmull_Rom_Spline_NormalizeX(p0,p1,p2,p3,f,o);break;case INTERPOLATE.CATMULL_ROM:Catmull_Rom_Spline(p0,p1,p2,p3,f,o);break;case INTERPOLATE.CATMULL_ROM_NORMALIZE:Catmull_Rom_Spline_Normalize(p0,p1,p2,p3,f,o);break;case INTERPOLATE.CATMULL_ROM_TANGENT:Catmull_Rom_Spline_Tangent(p0,p1,p2,p3,f,o);break;case INTERPOLATE.EASE_IN:VectorLerp(p1,p2,sin(f*PIDIV2),o);break;case INTERPOLATE.EASE_OUT:VectorLerp(p1,p2,1.0-sin(f*PIDIV2+PIDIV2),o);break;case INTERPOLATE.EASE_INOUT:VectorLerp(p1,p2,SimpleSpline(f),o);break;case INTERPOLATE.LINEAR_INTERP:VectorLerp(p1,p2,f,o);break;case INTERPOLATE.KOCHANEK_BARTELS:case INTERPOLATE.KOCHANEK_BARTELS_EARLY:case INTERPOLATE.KOCHANEK_BARTELS_LATE:local tbc=[null,null,null];Interpolator_GetKochanekBartelsParams(i,tbc);Kochanek_Bartels_Spline_NormalizeX(tbc[0],tbc[1],tbc[2],p0,p1,p2,p3,f,o);break;case INTERPOLATE.SIMPLE_CUBIC:Cubic_Spline_NormalizeX(p0,p1,p2,p3,f,o);break;case INTERPOLATE.BSPLINE:BSpline(p0,p1,p2,p3,f,o);break;case INTERPOLATE.EXPONENTIAL_DECAY:local dt=p2.x-p1.x;if(dt>0.0)o.y=p1.y+(1.0-ExponentialDecay(0.001,dt,f*dt))*(p2.y-p1.y);else o.y=p1.y;break;case INTERPOLATE.HOLD:o.y=p1.y;break;default:Msg(format("Unknown interpolation type %d\n",i))}}VS.Interpolator_CurveInterpolate_NonNormalized<-function(i,p0,p1,p2,p3,f,o):(sin){o.x=o.y=o.z=0.0;switch(i){case INTERPOLATE.CATMULL_ROM_NORMALIZEX:case INTERPOLATE.DEFAULT:case INTERPOLATE.CATMULL_ROM:case INTERPOLATE.CATMULL_ROM_NORMALIZE:case INTERPOLATE.CATMULL_ROM_TANGENT:Catmull_Rom_Spline(p0,p1,p2,p3,f,o);break;case INTERPOLATE.EASE_IN:VectorLerp(p1,p2,sin(f*PIDIV2),o);break;case INTERPOLATE.EASE_OUT:VectorLerp(p1,p2,1.0-sin(f*PIDIV2+PIDIV2),o);break;case INTERPOLATE.EASE_INOUT:VectorLerp(p1,p2,SimpleSpline(f),o);break;case INTERPOLATE.LINEAR_INTERP:VectorLerp(p1,p2,f,o);break;case INTERPOLATE.KOCHANEK_BARTELS:case INTERPOLATE.KOCHANEK_BARTELS_EARLY:case INTERPOLATE.KOCHANEK_BARTELS_LATE:local tbc=[null,null,null];Interpolator_GetKochanekBartelsParams(i,tbc);Kochanek_Bartels_Spline(tbc[0],tbc[1],tbc[2],p0,p1,p2,p3,f,o);break;case INTERPOLATE.SIMPLE_CUBIC:Cubic_Spline(p0,p1,p2,p3,f,o);break;case INTERPOLATE.BSPLINE:BSpline(p0,p1,p2,p3,f,o);break;case INTERPOLATE.EXPONENTIAL_DECAY:local dt=p2.x-p1.x;if(dt>0.0)o.y=p1.y+(1.0-ExponentialDecay(0.001,dt,f*dt))*(p2.y-p1.y);else o.y=p1.y;break;case INTERPOLATE.HOLD:o.y=p1.y;break;default:Msg(format("Unknown interpolation type %d\n",i))}}VS.Spline_Normalize<-function(p1,p2,p3,p4,p1n,p4n):(VectorLerp){local dt=p3.x-p2.x;p1n.x=p1.x;p1n.y=p1.y;p1n.z=p1.z;p4n.x=p4.x;p4n.y=p4.y;p4n.z=p4.z;if(dt){if(p1.x!=p2.x)VectorLerp(p2,p1,dt/(p2.x-p1.x),p1n);if(p4.x!=p3.x)VectorLerp(p3,p4,dt/(p4.x-p3.x),p4n)}}local Spline_Normalize=VS.Spline_Normalize;VS.Catmull_Rom_Spline<-function(p1,p2,p3,p4,t,out){local th=t*0.5,t2=t*th,t3=t*t2;local a=-t3+2.0*t2-th,b=3.0*t3-5.0*t2+1.0,c=-3.0*t3+4.0*t2+th,d=t3-t2;out.x=a*p1.x+b*p2.x+c*p3.x+d*p4.x;out.y=a*p1.y+b*p2.y+c*p3.y+d*p4.y;out.z=a*p1.z+b*p2.z+c*p3.z+d*p4.z}local Catmull_Rom_Spline=VS.Catmull_Rom_Spline;VS.Catmull_Rom_Spline_Tangent<-function(p1,p2,p3,p4,t,out){local t3=1.5*t*t;local a=-t3+2.0*t-0.5,b=3.0*t3-5.0*t,c=-3.0*t3+4.0*t+0.5,d=t3-t;out.x=a*p1.x+b*p2.x+c*p3.x+d*p4.x;out.y=a*p1.y+b*p2.y+c*p3.y+d*p4.y;out.z=a*p1.z+b*p2.z+c*p3.z+d*p4.z}VS.Catmull_Rom_Spline_Integral<-function(p1,p2,p3,p4,t,out){local tt=t*t,ttt=tt*t;local o=p2*t-0.25*(p1-p3)*tt+0.166667*(2.0*p1-5.0*p2+4.0*p3-p4)*ttt-0.125*(p1-3.0*p2+3.0*p3-p4)*ttt*t;out.x=o.x;out.y=o.y;out.z=o.z}VS.Catmull_Rom_Spline_Integral2<-function(p1,p2,p3,p4,t,out){local o=((p2+p3)*3.25-(p1+p4)*0.25)*0.166667;out.x=o.x;out.y=o.y;out.z=o.z}VS.Catmull_Rom_Spline_Normalize<-function(p1,p2,p3,p4,t,out):(VectorMA,Catmull_Rom_Spline){local dt=(p3-p2).Length(),p1n=p1-p2,p4n=p4-p3;p1n.Norm();p4n.Norm();VectorMA(p2,dt,p1n,p1n);VectorMA(p3,dt,p4n,p4n);return Catmull_Rom_Spline(p1n,p2,p3,p4n,t,out)}VS.Catmull_Rom_Spline_Integral_Normalize<-function(p1,p2,p3,p4,t,out):(VectorMA){local dt=(p3-p2).Length(),p1n=p1-p2,p4n=p4-p3;p1n.Norm();p4n.Norm();VectorMA(p2,dt,p1n,p1n);VectorMA(p3,dt,p4n,p4n);return Catmull_Rom_Spline_Integral(p1n,p2,p3,p4n,t,out)}VS.Catmull_Rom_Spline_NormalizeX<-function(p1,p2,p3,p4,t,out):(Vector,Spline_Normalize,Catmull_Rom_Spline){local p1n=Vector(),p4n=Vector();Spline_Normalize(p1,p2,p3,p4,p1n,p4n);return Catmull_Rom_Spline(p1n,p2,p3,p4n,t,out)}VS.Hermite_Spline<-function(p1,p2,d1,d2,t,out){local t2=t*t,t3=t*t2;local b1=2.0*t3-3.0*t2+1.0,b2=1.0-b1,b3=t3-2.0*t2+t,b4=t3-t2;out.x=b1*p1.x+b2*p2.x+b3*d1.x+b4*d2.x;out.y=b1*p1.y+b2*p2.y+b3*d1.y+b4*d2.y;out.z=b1*p1.z+b2*p2.z+b3*d1.z+b4*d2.z}VS.Hermite_SplineF<-function(p1,p2,d1,d2,t){local t2=t*t,t3=t*t2;local b1=2.0*t3-3.0*t2+1.0;return b1*p1+(1.0-b1)*p2+(t3-2.0*t2+t)*d1+(t3-t2)*d2}VS.Hermite_SplineBasis<-function(t,b){local t2=t*t,t3=t*t2;b[0]=2.0*t3-3.0*t2+1.0;b[1]=1.0-b[0];b[2]=t3-2.0*t2+t;b[3]=t3-t2}local Hermite_Spline=VS.Hermite_Spline,Hermite_SplineF=VS.Hermite_SplineF;VS.Hermite_Spline3V<-function(p0,p1,p2,t,out):(Hermite_Spline){return Hermite_Spline(p1,p2,p1-p0,p2-p1,t,out)}VS.Hermite_Spline3F<-function(p0,p1,p2,t):(Hermite_SplineF){return Hermite_SplineF(p1,p2,p1-p0,p2-p1,t)}local Hermite_Spline3F=VS.Hermite_Spline3F;VS.Hermite_Spline3Q<-function(q0,q1,q2,t,out):(Quaternion,QuaternionAlign,QuaternionNormalize,Hermite_Spline3F){local q0a=Quaternion(),q1a=Quaternion();QuaternionAlign(q2,q0,q0a);QuaternionAlign(q2,q1,q1a);out.x=Hermite_Spline3F(q0a.x,q1a.x,q2.x,t);out.y=Hermite_Spline3F(q0a.y,q1a.y,q2.y,t);out.z=Hermite_Spline3F(q0a.z,q1a.z,q2.z,t);out.w=Hermite_Spline3F(q0a.w,q1a.w,q2.w,t);QuaternionNormalize(out)}VS.Kochanek_Bartels_Spline<-function(pt,pb,pc,p1,p2,p3,p4,t,out){local ffa=(1.0-pt)*(1.0+pc)*(1.0+pb),ffb=(1.0-pt)*(1.0-pc)*(1.0-pb),ffc=(1.0-pt)*(1.0-pc)*(1.0+pb),ffd=(1.0-pt)*(1.0+pc)*(1.0-pb);local th=t*0.5,t2=t*th,t3=t*t2;local a=t3*-ffa+t2*2.0*ffa-th*ffa,b=t3*(4.0+ffa-ffb-ffc)+t2*(-6.0-2.0*ffa+2.0*ffb+ffc)+th*(ffa-ffb)+1.0,c=t3*(-4.0+ffb+ffc-ffd)+t2*(6.0-2.0*ffb-ffc+ffd)+th*ffb,d=t3*ffd-t2*ffd;out.x=a*p1.x+b*p2.x+c*p3.x+d*p4.x;out.y=a*p1.y+b*p2.y+c*p3.y+d*p4.y;out.z=a*p1.z+b*p2.z+c*p3.z+d*p4.z}local Kochanek_Bartels_Spline=VS.Kochanek_Bartels_Spline;VS.Kochanek_Bartels_Spline_NormalizeX<-function(pt,pb,pc,p1,p2,p3,p4,t,out):(Vector,Spline_Normalize,Kochanek_Bartels_Spline){local p1n=Vector(),p4n=Vector();Spline_Normalize(p1,p2,p3,p4,p1n,p4n);return Kochanek_Bartels_Spline(pt,pb,pc,p1n,p2,p3,p4n,t,out)}VS.Cubic_Spline<-function(p1,p2,p3,p4,t,out){local t2=t*t,t3=t*t2;local b=t3*2.0-t2*3.0+1.0,c=t3*-2.0+t2*3.0;out.x=b*p2.x+c*p3.x;out.y=b*p2.y+c*p3.y;out.z=b*p2.z+c*p3.z}local Cubic_Spline=VS.Cubic_Spline;VS.Cubic_Spline_NormalizeX<-function(p1,p2,p3,p4,t,out):(Vector,Spline_Normalize,Cubic_Spline){local p1n=Vector(),p4n=Vector();Spline_Normalize(p1,p2,p3,p4,p1n,p4n);return Cubic_Spline(p1n,p2,p3,p4n,t,out)}VS.BSpline<-function(p1,p2,p3,p4,t,out){local th=t*0.166667,t2=t*th,t3=t*t2;local a=-t3+t2*3.0-th*3.0+0.166667,b=t3*3.0-t2*6.0+0.666668,c=t3*-3.0+t2*3.0+th*3.0+0.166667;out.x=a*p1.x+b*p2.x+c*p3.x+t3*p4.x;out.y=a*p1.y+b*p2.y+c*p3.y+t3*p4.y;out.z=a*p1.z+b*p2.z+c*p3.z+t3*p4.z}local BSpline=VS.BSpline;VS.BSpline_NormalizeX<-function(p1,p2,p3,p4,t,out):(Vector,Spline_Normalize,BSpline){local p1n=Vector(),p4n=Vector();Spline_Normalize(p1,p2,p3,p4,p1n,p4n);return BSpline(p1n,p2,p3,p4n,t,out)}VS.Parabolic_Spline<-function(p1,p2,p3,p4,t,out){local th=t*0.5,t2=t*th;local a=t2-t+0.5,b=t2*-2.0+t+0.5;out.x=a*p1.x+b*p2.x+t2*p3.x;out.y=a*p1.y+b*p2.y+t2*p3.y;out.z=a*p1.z+b*p2.z+t2*p3.z}local Parabolic_Spline=VS.Parabolic_Spline;VS.Parabolic_Spline_NormalizeX<-function(p1,p2,p3,p4,t,out):(Vector,Spline_Normalize,Parabolic_Spline){local p1n=Vector(),p4n=Vector();Spline_Normalize(p1,p2,p3,p4,p1n,p4n);return Parabolic_Spline(p1n,p2,p3,p4n,t,out)}VS.RangeCompressor<-function(v,n,x,b):(Hermite_SplineF){if(b<n)b=n;else if(b>x)b=x;;local m=(b+v-n)/(x-n),g=m*2.0-1.0,a;if(g<0.0)a=-g;else a=g;if(a>0.75){local t=(a-0.75)/1.25;if(t<1.0){if(g>0.0)g=Hermite_SplineF(0.75,1.0,0.75,0.0,t);else g=-Hermite_SplineF(0.75,1.0,0.75,0.0,t)}else{if(0.0<g)g=1.0;else g=-1.0}};m=(g+1.0)*0.5;return(n*(1.0-m)+x*m)-b}VS.InterpolateAngles<-function(v1,v2,t,out):(Quaternion,AngleQuaternion,QuaternionAngles,QuaternionSlerp){if(v1==v2)return v1;local src=Quaternion(),dst=Quaternion();AngleQuaternion(v1,src);AngleQuaternion(v2,dst);return QuaternionAngles(QuaternionSlerp(src,dst,t),out)}}VS.PointOnLineNearestPoint<-function(vs,ve,vp){local v1=ve-vs,d=v1.Dot(vp-vs)/v1.LengthSqr();if(d<0.0)return vs;if(d>1.0)return ve;return vs+v1*d}VS.CalcSqrDistanceToAABB<-function(n,x,p){local dt;if(p.x<n.x)dt=n.x-p.x;else if(p.x>x.x)dt=p.x-x.x;;if(p.y<n.y)dt=n.y-p.y;else if(p.y>x.y)dt=p.y-x.y;;if(p.z<n.z)dt=n.z-p.z;else if(p.z>x.z)dt=p.z-x.z;;return dt*dt}VS.CalcClosestPointOnAABB<-function(n,x,p,out=_VEC){out.x=(p.x<n.x)?n.x:(x.x<p.x)?x.x:p.x;out.y=(p.y<n.y)?n.y:(x.y<p.y)?x.y:p.y;out.z=(p.z<n.z)?n.z:(x.z<p.z)?x.z:p.z}class::Ray_t{m_Start=null;m_Delta=null;m_StartOffset=null;m_Extents=null;m_IsRay=null;m_IsSwept=null;function Init(v0,v1,n=null,x=null):(Vector){m_Delta=v1-v0;m_IsSwept=(m_Delta.LengthSqr()!=0.0);if(!n){m_Extents=Vector();m_IsRay=true;m_StartOffset=Vector();m_Start=v0*1.0}else{m_Extents=(x-n)*0.5;m_IsRay=(m_Extents.LengthSqr()<1.e-6);m_StartOffset=(n+x)*0.5;m_Start=v0+m_StartOffset;m_StartOffset*=-1.0}}}VS.ComputeBoxOffset<-function(ray):(fabs){if(ray.m_IsRay)return 1.e-3;local f=fabs(ray.m_Extents.x*ray.m_Delta.x)+fabs(ray.m_Extents.y*ray.m_Delta.y)+fabs(ray.m_Extents.z*ray.m_Delta.z);local l=ray.m_Delta.LengthSqr();if(l>=1.0)return(f/l)+1.e-3;return f+1.e-3}VS.IsPointInBox<-function(v,n,x){return(v.x>=n.x&&v.x<=x.x&&v.y>=n.y&&v.y<=x.y&&v.z>=n.z&&v.z<=x.z)}VS.IsBoxIntersectingBox<-function(n1,x1,n2,x2){if((n1.x>x2.x)||(x1.x<n2.x))return false;if((n1.y>x2.y)||(x1.y<n2.y))return false;if((n1.z>x2.z)||(x1.z<n2.z))return false;return true}VS.IsPointInCone<-function(pt,vo,x,c,l){local dt=pt-vo,s=dt.Norm(),p=dt.Dot(x);if(p<c)return false;if(s*p>l)return false;return true}VS.IsSphereIntersectingSphere<-function(c1,r1,c2,r2){local rr=r1+r2;return(c2-c1).LengthSqr()<=(rr*rr)}VS.IsBoxIntersectingSphere<-function(n,x,c,r){local dt;if(c.x<n.x)dt=c.x-n.x;else if(c.x>x.x)dt=x.x-c.x;;if(c.y<n.y)dt=c.y-n.y;else if(c.y>x.y)dt=x.y-c.y;;if(c.z<n.z)dt=c.z-n.z;else if(c.z>x.z)dt=x.z-c.z;;return dt*dt<r*r}VS.IsCircleIntersectingRectangle<-function(n,x,c,r){local dt;if(c.x<n.x)dt=c.x-n.x;else if(c.x>x.x)dt=x.x-c.x;;if(c.y<n.y)dt=c.y-n.y;else if(c.y>x.y)dt=x.y-c.y;;return dt*dt<r*r}VS.IsRayIntersectingSphere<-function(ro,rdt,ct,rd,tol=0.0){rd+=tol;local r2s=ct-ro;local n=r2s.Dot(rdt);local t;if(n<=0.0)t=0.0;else{local d=rdt.LengthSqr();if(n>d)t=1.0;else t=n/d};return((ro+rdt*t)-ct).LengthSqr()<=rd*rd}VS.IntersectInfiniteRayWithSphere<-function(ro,rdt,ct,rd,pT):(sqrt){local s2r=ro-ct,a=rdt.LengthSqr();if(!a){pT[0]=pT[1]=0.0;return s2r.LengthSqr()<=rd*rd};local b=2.0*s2r.Dot(rdt),c=s2r.LengthSqr()-rd*rd;local d=b*b-4.0*a*c;if(d<0.0)return false;d=sqrt(d);local oo2a=0.5/a;pT[0]=(-d-b)*oo2a;pT[1]=(d-b)*oo2a;return true}VS.IsBoxIntersectingRay<-function(n,x,o,dt,tol=0.0):(fabs){local tmin=FLT_MIN,tmax=FLT_MAX;if(fabs(dt.x)<1.e-8){if((o.x<n.x-tol)||(o.x>x.x+tol))return false}else{local id=1.0/dt.x;local t1=(n.x-tol-o.x)*id,t2=(x.x+tol-o.x)*id;if(t1>t2){local tt=t1;t1=t2;t2=tt};if(t1>tmin)tmin=t1;if(t2<tmax)tmax=t2;if(tmin>tmax)return false;if(tmax<0.0)return false;if(tmin>1.0)return false};if(fabs(dt.y)<1.e-8){if((o.y<n.y-tol)||(o.y>x.y+tol))return false}else{local id=1.0/dt.y;local t1=(n.y-tol-o.y)*id,t2=(x.y+tol-o.y)*id;if(t1>t2){local tt=t1;t1=t2;t2=tt};if(t1>tmin)tmin=t1;if(t2<tmax)tmax=t2;if(tmin>tmax)return false;if(tmax<0.0)return false;if(tmin>1.0)return false};if(fabs(dt.z)<1.e-8){if((o.z<n.z-tol)||(o.z>x.z+tol))return false}else{local id=1.0/dt.z;local t1=(n.z-tol-o.z)*id,t2=(x.z+tol-o.z)*id;if(t1>t2){local tt=t1;t1=t2;t2=tt};if(t1>tmin)tmin=t1;if(t2<tmax)tmax=t2;if(tmin>tmax)return false;if(tmax<0.0)return false;if(tmin>1.0)return false};return true}local IsBoxIntersectingRay=VS.IsBoxIntersectingRay;VS.IsBoxIntersectingRay2<-function(o,n,x,ray,tol=0.0):(IsBoxIntersectingRay){if(!ray.m_IsSwept){local rn=ray.m_Start-ray.m_Extents,rx=ray.m_Start+ray.m_Extents;if(tol){rn.x-=tol;rn.y-=tol;rn.z-=tol;rx.x+=tol;rx.y+=tol;rx.z+=tol};return IsBoxIntersectingBox(n,x,rn,rx)};return IsBoxIntersectingRay(n-ray.m_Extents+o,x+ray.m_Extents+o,ray.m_Start,ray.m_Delta,tol)}VS.IntersectRayWithRay<-function(v0,d0,v1,d1){local v0xv1=d0.Cross(d1);local ls=v0xv1.LengthSqr();if(!ls)return false;local p1p0=v1-v0;local AxC=p1p0.Cross(v0xv1);VectorNegate(AxC);local detT=AxC.Dot(d1);AxC=p1p0.Cross(v0xv1);VectorNegate(AxC);local detS=AxC.Dot(d0),invL=1.0/ls;local t=detT*invL,s=detS*invL;local i0=v0+d0*t,i1=v1+d1*s;return i0.x==i1.x&&i0.y==i1.y&&i0.z==i1.z}VS.IntersectRayWithPlane<-function(o,v,n,f){local d=v.Dot(n);if(d)return(f-o.Dot(n))/d;return 0.0}VS.IsRayIntersectingOBB<-function(ray,org,ang,mins,maxs):(matrix3x4_t,Vector,Ray_t,DotProductAbs){if(VectorIsZero(ang))return IsBoxIntersectingRay(org+mins,org+maxs,ray.m_Start,ray.m_Delta);if(ray.m_IsRay){local w2b=matrix3x4_t(),rr=Ray_t.instance();AngleIMatrix(ang,org,w2b);rr.m_Start=Vector();rr.m_Delta=Vector();VectorTransform(ray.m_Start,w2b,rr.m_Start);VectorRotate(ray.m_Delta,w2b,rr.m_Delta);rr.m_StartOffset=Vector();rr.m_Extents=Vector();rr.m_IsRay=true;rr.m_IsSwept=ray.m_IsSwept;return IsBoxIntersectingRay2(rr.m_StartOffset,mins,maxs,rr)};local b2w=matrix3x4_t();ComputeCenterMatrix(org,ang,mins,maxs,b2w);local bs=(maxs-mins)*0.5;local rd=ray.m_Delta*1;rd.Norm();local rdb2=VectorIRotate(rd,b2w);VectorAbs(rdb2);b2w=b2w.m;local ctdt=Vector(b2w[0][3]-ray.m_Start.x,b2w[1][3]-ray.m_Start.y,b2w[2][3]-ray.m_Start.z),pnm,bps,ctdtp;pnm=rd.Cross(Vector(b2w[0][0],b2w[1][0],b2w[2][0]));ctdtp=pnm.Dot(ctdt);if(0.0>ctdtp)ctdtp=-ctdtp;bps=rdb2.z*bs.y+rdb2.y*bs.z+DotProductAbs(pnm,ray.m_Extents);if(ctdtp>bps)return false;pnm=rd.Cross(Vector(b2w[0][1],b2w[1][1],b2w[2][1]));ctdtp=pnm.Dot(ctdt);if(0.0>ctdtp)ctdtp=-ctdtp;bps=rdb2.z*bs.x+rdb2.x*bs.z+DotProductAbs(pnm,ray.m_Extents);if(ctdtp>bps)return false;pnm=rd.Cross(Vector(b2w[0][2],b2w[1][2],b2w[2][2]));ctdtp=pnm.Dot(ctdt);if(0.0>ctdtp)ctdtp=-ctdtp;bps=rdb2.y*bs.x+rdb2.x*bs.y+DotProductAbs(pnm,ray.m_Extents);if(ctdtp>bps)return false;return true}}::Ent<-function(s,i=null):(Entities)return Entities.FindByName(i,s);::Entc<-function(s,i=null):(Entities)return Entities.FindByClassname(i,s);::VecToString<-function(v):(Fmt)return Fmt("Vector(%.6g, %.6g, %.6g)",v.x,v.y,v.z);local tr1=TraceLine,tr2=TraceLinePlayersIncluded;const MASK_NPCWORLDSTATIC=0x2000b;;const MASK_SOLID=0x200400b;;class VS.TraceLine{constructor(v1,v2,e=null,nm=MASK_NPCWORLDSTATIC):(tr1,tr2){startpos=v1;endpos=v2;ignore=e;mask=nm;switch(nm){case MASK_NPCWORLDSTATIC:fraction=tr1(startpos,endpos,ignore);return;case MASK_SOLID:fraction=tr2(startpos,endpos,ignore);return;default:throw"invalid mask"}}function _cmp(d){if(fraction<d.fraction)return -1;if(fraction>d.fraction)return 1;return 0}function _add(d){return fraction+d.fraction}function _sub(d){return fraction-d.fraction}function _mul(d){return fraction*d.fraction}function _div(d){return fraction/d.fraction}function _modulo(d){return fraction%d.fraction}function _unm(){return -fraction}function _typeof(){return"trace_t"}startpos=null;endpos=null;ignore=null;fraction=null;hitpos=null;normal=null;mask=null}local CTrace=VS.TraceLine;VS.TraceDir<-function(v1,d,f=MAX_TRACE_LENGTH,e=null,m=MASK_NPCWORLDSTATIC):(CTrace){return CTrace(v1,v1+(d*f),e,m)}VS.TraceLine.DidHit<-function(){return fraction<1.0}VS.TraceLine.GetEnt<-function(radius):(Entities){if(!hitpos)GetPos();return Entities.FindByClassnameNearest("*",hitpos,radius)}VS.TraceLine.GetEntByName<-function(targetname,radius):(Entities){if(!hitpos)GetPos();return Entities.FindByNameNearest(targetname,hitpos,radius)}VS.TraceLine.GetEntByClassname<-function(classname,radius):(Entities){if(!hitpos)GetPos();return Entities.FindByClassnameNearest(classname,hitpos,radius)}VS.TraceLine.GetPos<-function(){if(!hitpos){if(fraction<1.0)hitpos=startpos+(endpos-startpos)*fraction;else hitpos=endpos};return hitpos}VS.TraceLine.GetDist<-function(){if(!hitpos)GetPos();return(startpos-hitpos).Length()}VS.TraceLine.GetDistSqr<-function(){if(!hitpos)GetPos();return(startpos-hitpos).LengthSqr()}VS.TraceLine.GetNormal<-function():(Vector,CTrace){if(!normal){local up=Vector(0.0,0.0,0.1);local dt=endpos-startpos;dt.Norm();GetPos();local v1=startpos+dt.Cross(up);local v2=startpos+up;normal=(hitpos-CTrace(v1,v1+dt*MAX_TRACE_LENGTH,ignore,mask).GetPos()).Cross(hitpos-CTrace(v2,v2+dt*MAX_TRACE_LENGTH,ignore,mask).GetPos());normal.Norm()};return normal}VS.UniqueString<-function():(DoUniqueString){return DoUniqueString("").slice(0,-1)}VS.DumpScope<-function(I,A=false,P=true,G=true,D=0){local _S=["Assert","Document","Documentation","PrintHelp","RetrieveNativeSignature","UniqueString","IncludeScript","Entities","CSimpleCallChainer","CCallChainer","LateBinder","__ReplaceClosures","__DumpScope","printl","VSquirrel_OnCreateScope","VSquirrel_OnReleaseScope","PrecacheCallChain","OnPostSpawnCallChain","DispatchOnPostSpawn","DispatchPrecache","OnPostSpawn","PostSpawn","Precache","PreSpawnInstance","__EntityMakerResult","__FinishSpawn","__ExecutePreSpawn","EntFireByHandle","EntFire","RAND_MAX","_version_","_intsize_","PI","_charsize_","_floatsize_","self","__vname","__vrefs","{847D4B}","VS","Chat","ChatTeam","txt","PrecacheModel","PrecacheScriptSound","delay","OnGameEvent_player_spawn","OnGameEvent_player_connect","VecToString","HPlayer","Ent","Entc","Quaternion","matrix3x4_t","VMatrix","Ray_t","max","min","clamp","MAX_COORD_FLOAT","MAX_TRACE_LENGTH","DEG2RAD","RAD2DEG","CONST"];local dn=function(c)for(local i=c;i--;)print("   ");local SW=Entities.First().GetScriptScope();if(G)print(" ------------------------------\n");if(I){foreach(key,val in I){local ty=typeof val,bS=false;if(!A){switch(ty){case"native function":bS=true;break;case"class":foreach(k,v in val){if(typeof v=="native function"){bS=true;break}}break;case"table":if(val==SW)bS=true;break}if(!bS){foreach(k in _S)if(key==k){bS=true;break}}}else if(key=="VS"||key=="Documentation")bS=true;;if(!bS){dn(D);print(key);switch(ty){case"table":print("(TABLE) : "+val.len());if(!P)break;print("\n");dn(D);print("{\n");DumpScope(val,A,P,false,D+1);dn(D);print("}");break;case"array":print("(ARRAY) : "+val.len());if(!P)break;print("\n");dn(D);print("[\n");DumpScope(val,A,P,false,D+1);dn(D);print("]");break;case"string":print(" = \""+val+"\"");break;case"Vector":print(" = "+VecToString(val));break;default:print(" = "+val)}print("\n")}}}else print("(NULL)\n");if(G)print(" ------------------------------\n")}VS.ArrayToTable<-function(a){local t={}foreach(i,v in a)t[i]<-v;return t}VS.PrintStack<-function(l=0):(Fmt,getstackinfos,ROOT,CBaseEntity){if(l<0)l=0;l+=2;print("\nCALLSTACK\n");local si,st=[];while(si=getstackinfos(l++)){if(si.src=="NATIVE"&&si.func=="pcall")break;if(l>=12)break;print(Fmt("*FUNCTION [%s()] %s line [%d]\n",si.func,si.src,si.line));st.append(si)}print("\nLOCALS\n");foreach(si in st){local T;foreach(nm,v in si.locals){switch(typeof v){case"integer":print(Fmt("[%s] %d\n",nm,v));break;case"float":print(Fmt("[%s] %.14g\n",nm,v));break;case"string":print(Fmt("[%s] \"%s\"\n",nm,v));break;case"table":if(nm=="this"){T=v;break};if(v==ROOT){print(Fmt("[%s] TABLE (ROOT)\n",nm));break};print(Fmt("[%s] TABLE\n",nm));break;case"function":print(Fmt("[%s] CLOSURE\n",nm));break;case"native function":print(Fmt("[%s] NATIVECLOSURE\n",nm));break;case"bool":print(Fmt("[%s] %s\n",nm,""+v));break;case"instance":if(v instanceof CBaseEntity){print(Fmt("[%s] CBaseEntity\n",nm));break};default:print(Fmt("[%s] %s\n",nm,(typeof v).toupper()))}}if(T){if(T==ROOT)print("[this] TABLE (ROOT)\n");else{local s;if(s=GetVarName(T))print(Fmt("[this] TABLE (%s)\n",s));else print("[this] TABLE\n")}}}}VS.GetCaller<-function():(getstackinfos)return getstackinfos(3).locals["this"];VS.GetCallerFunc<-function():(getstackinfos)return getstackinfos(3).func;VS.GetTableDir<-function(I){if(typeof I!="table")throw"Invalid input type '"+typeof I+"' ; expected: 'table'";local a=[];local r=_10F07AD9(a,I);if(r){r.insert(r.len(),"roottable");r.reverse()}else{r=a;r.clear();r.resize(1);r[0]="roottable"};return r}VS._10F07AD9<-function(bF,t,l=ROOT){foreach(v,u in l)if(typeof u=="table"&&v!="VS"&&v!="Documentation")if(u==t){bF.append(v);return bF}else{local r=_10F07AD9(bF,t,u);if(r){bF.append(v);return r}}}VS.FindVarByName<-function(S){if(typeof S!="string")throw"Invalid input type '"+typeof S+"' ; expected: 'string'";return _2E42074F(S)}VS._2E42074F<-function(t,l=ROOT){if(t in l)return l[t];else foreach(v,u in l)if(typeof u=="table"&&v!="VS"&&v!="Documentation"){local r=_2E42074F(t,u);if(r)return r}}VS.GetVarName<-function(v){local t=typeof v;if(t=="function"||t=="native function")return v.getinfos().name;return _8B78B6AE(t,v)}VS._8B78B6AE<-function(t,i,s=ROOT){foreach(k,v in s){if(v==i)return k;if(typeof v=="table"&&k!="VS"&&k!="Documentation"){local r=_8B78B6AE(t,i,v);if(r)return r}}}local World=Entc("worldspawn");if(!World){Msg("ERROR: could not find worldspawn\n");World=Entities.CreateByClassname("soundent")};;::delay<-function(X,T=0.0,E=World,A=null,C=null):(AddEvent)return AddEvent(E,"RunScriptCode",""+X,T,A,C);{local EQ={m_flNextQueue=-1.0,m_flLastQueue=-1.0}VS.EventQueue<-EQ;local E=[null,null];E[1]=FLT_MAX_N;EQ.Dump<-function(tk=false,dn=0):(E,Time,Fmt,TI){local g=function(i):(Fmt){if(i==null)return"(NULL)";local s=""+i;local t=s.find("0x");if(t==null)return s;return Fmt("(%s)",s.slice(t,-1))},T2T=function(dt):(TI){return((0.5+dt)/TI).tointeger()},n="";for(local i=dn;i--;)n+="    ";Msg(Fmt(n+"VS::EventQueue::Dump: %.6g : next(%.6g), last(%.6g)\n",tk?T2T(Time()):Time(),tk?(m_flNextQueue==-1.0?-1.0:T2T(m_flNextQueue)):m_flNextQueue,tk?T2T(m_flLastQueue):m_flLastQueue));for(local ev=E;ev=ev[0];){local fn=ev[3].getinfos().name,ta=typeof ev[4]=="array"&&ev[4].len();Msg(Fmt(n+"   (%s) func '%s'%s, %s '%s', activator '%s', caller '%s'\n",tk?""+T2T(ev[1]):Fmt("%.2f",ev[1]),fn?fn:"<unnamed>",g(ev[3]),ta?"arg":"env",g(ta?ev[4][0]:ev[5]),g(ev[6]),g(ev[7])))}Msg(n+"VS::EventQueue::Dump: end.\n")}.bindenv(EQ);EQ.Clear<-function():(E){local ev=E[0];while(ev){local next=ev[0];ev[0]=null;ev[2]=null;ev=next}E[0]=null;m_flNextQueue=m_flLastQueue=-1.0}.bindenv(EQ);EQ.CancelEventsByInput<-function(f):(E){local ev=E;while(ev=ev[0]){if(f==ev[3]){ev[2][0]=ev[0];if(ev[0])ev[0][2]=ev[2]}}if(!E[0])m_flNextQueue=-1.0}.bindenv(EQ);EQ.RemoveEvent<-function(ev):(E){if(typeof ev=="weakref")ev=ev.ref();local pe=E;while(pe=pe[0]){if(ev==pe){ev[2][0]=ev[0];if(ev[0])ev[0][2]=ev[2];if(!E[0])m_flNextQueue=-1.0;return}}}.bindenv(EQ);EQ.AddEventInternal<-function(iv,dl):(World,Time,AddEvent,E,TI){local t=Time();local flFireTime=t+dl;iv[1]=flFireTime;local ev=E;while(ev[0]){if(iv[1]<ev[0][1])break;ev=ev[0]}iv[0]=ev[0];iv[2]=ev;ev[0]=iv;if(m_flLastQueue!=t){m_flLastQueue=t;if((m_flNextQueue==-1.0)||(flFireTime<m_flNextQueue)){m_flNextQueue=flFireTime;AddEvent(World,"CallScriptFunction","VS_EventQueue_ServiceEvents",0.0,iv[6],iv[7])}else if(E[0]&&((t-E[0][1]-0.001)>=TI)){Clear();return AddEventInternal(iv,dl)}};return iv.weakref()}.bindenv(EQ);local AddEventInternal=EQ.AddEventInternal;EQ.AddEvent<-function(fn,dl,av=null,ar=null,cr=null):(AddEventInternal,ROOT){local ev=[null,null,null,fn,null,null,ar,cr];switch(typeof av){case"table":case"class":case"instance":ev[5]=av;break;case"array":ev[4]=av;break;default:ev[5]=ROOT}return AddEventInternal(ev,dl)}.bindenv(EQ);EQ.CreateEvent<-function(fn,av=null,ar=null,cr=null):(ROOT){local ev=[null,null,null,fn,null,null,ar,cr];switch(typeof av){case"table":case"class":case"instance":ev[5]=av;break;case"array":ev[4]=av;break;default:ev[5]=ROOT}return ev}EQ.ServiceEvents<-function():(World,AddEvent,E,Time){local t=Time(),ev=E;while(ev=ev[0]){local f=ev[1];if(f<=t){local f=ev[3];if(f){local p=ev[4];if(p)f.acall(p);else f.call(ev[5])};ev[2][0]=ev[0];if(ev[0])ev[0][2]=ev[2];ev=E}else{m_flNextQueue=f;return AddEvent(World,"CallScriptFunction","VS_EventQueue_ServiceEvents",f-t,ev[6],ev[7])}}m_flNextQueue=-1.0}.bindenv(EQ);World.ValidateScriptScope();World.GetScriptScope().VS_EventQueue_ServiceEvents<-EQ.ServiceEvents.weakref()}if(!PORTAL2){::Chat<-function(s):(ScriptPrintMessageChatAll)return ScriptPrintMessageChatAll(" "+s);::ChatTeam<-function(i,s):(ScriptPrintMessageChatTeam)return ScriptPrintMessageChatTeam(i," "+s);::Alert<-ScriptPrintMessageCenterAll;::AlertTeam<-ScriptPrintMessageCenterTeam;::txt<-{white="\x01",red="\x02",purple="\x03",green="\x04",lightgreen="\x05",limegreen="\x06",lightred="\x07",grey="\x08",yellow="\x09",lightblue="\x0a",blue="\x0b",darkblue="\x0c",darkgrey="\x0d",pink="\x0e",orangered="\x0f",orange="\x10"}};;::EntFireByHandle<-function(T,A,V="",dl=0.0,ar=null,cr=null):(AddEvent)return AddEvent(T,""+A,""+V,dl,ar,cr);::EntFire<-function(T,A,V="",dl=0.0,ar=null):(DoEntFire){if(!V)V="";local cr;if("self"in this){cr=self;if(!ar)ar=self};return DoEntFire(""+T,""+A,""+V,dl,ar,cr)}::PrecacheModel<-function(s):(World)World.PrecacheModel(s);::PrecacheScriptSound<-function(s):(World)World.PrecacheSoundScript(s);VS.MakePersistent<-function(e)return e.__KeyValueFromString("classname","soundent");VS.SetParent<-function(t,p):(AddEvent){if(p)return AddEvent(t,"SetParent","!activator",0.0,p,null);return AddEvent(t,"ClearParent","",0.0,null,null)}VS.CreateMeasure<-function(g,n=null,p=false,e=true,s=1.0):(AddEvent){local r=e?n?n+"":"vs.ref_"+UniqueString():n?n+"":null;if(!r||!r.len())throw"Invalid targetname";local e=CreateEntity("logic_measure_movement",{measuretype=e?1:0,measurereference="",targetreference=r,target=r,measureretarget="",targetscale=s.tofloat(),targetname=e?r:null},p);AddEvent(e,"SetMeasureReference",r,0.0,null,null);AddEvent(e,"SetMeasureTarget",g,0.0,null,null);AddEvent(e,"Enable","",0.0,null,null);return e}VS.SetMeasure<-function(h,s):(AddEvent)return AddEvent(h,"SetMeasureTarget",s,0.0,null,null);VS.CreateTimer<-function(D,fq,lo=null,hi=null,oc=false,ps=false):(AddEvent){local e=CreateEntity("logic_timer",null,ps);if(fq!=null){e.__KeyValueFromInt("UseRandomTime",0);e.__KeyValueFromFloat("RefireTime",fq.tofloat())}else{e.__KeyValueFromFloat("LowerRandomBound",lo.tofloat());e.__KeyValueFromFloat("UpperRandomBound",hi.tofloat());e.__KeyValueFromInt("UseRandomTime",1);e.__KeyValueFromInt("spawnflags",oc.tointeger())};AddEvent(e,D?"Disable":"Enable","",0.0,null,null);return e}VS.Timer<-function(D,fq,fn=null,sc=null,nv=false,ps=false){if(fq==null){Msg("\nERROR:\nRefire time cannot be null in VS.Timer\nUse VS.CreateTimer for randomised fire times.\n");throw"NULL REFIRE TIME"};local h=CreateTimer(D,fq,null,null,null,ps);OnTimer(h,fn,sc?sc:GetCaller(),nv);return h}VS.OnTimer<-function(e,fn,sc=null,nv=false)return AddOutput(e,"OnTimer",fn,sc?sc:GetCaller(),nv);VS.AddOutput<-function(e,op,fn,sc=null,nv=false):(compilestring){if(!sc)sc=GetCaller();if(fn){if(typeof fn=="string"){if(fn.find("(")!=null)fn=compilestring(fn);else fn=sc[fn]}else if(typeof fn!="function")throw"Invalid function type "+typeof fn}else{fn=null;nv=true};e.ValidateScriptScope();local r=e.GetScriptScope();r[op]<-nv?fn:fn.bindenv(sc);e.ConnectOutput(op,op);return r}VS.CreateEntity<-function(c,kv=null,p=false):(Entities){local e=Entities.CreateByClassname(c);if(typeof kv=="table")foreach(k,v in kv)SetKeyValue(e,k,v);if(p)MakePersistent(e);return e}VS.SetKeyValue<-function(e,k,v){switch(typeof v){case"bool":case"integer":return e.__KeyValueFromInt(k,v.tointeger());case"float":return e.__KeyValueFromFloat(k,v);case"string":return e.__KeyValueFromString(k,v);case"Vector":return e.__KeyValueFromVector(k,v);case"null":return true;default:throw"Invalid input type: "+typeof v}}VS.SetName<-function(e,n)return e.__KeyValueFromString("targetname",""+n);VS.DumpEnt<-function(I=null):(Entities,Fmt){if(!I){local e;while(e=Entities.Next(e)){local s=e.GetScriptScope();if(s)Msg(Fmt("%s :: %s\n",""+e,s.__vname))}return};if(typeof I=="string"){local e;while(e=Entities.Next(e))if(""+e==I)I=e};if(typeof I=="instance"){if(I.IsValid()){local s=I.GetScriptScope();if(s){Msg(Fmt("--- Script dump for entity %s\n",""+I));DumpScope(s,0,1,0,1);Msg("--- End script dump\n")}else return Msg(Fmt("Entity has no script scope! %s\n",""+I))}else return Msg("Invalid entity!\n")}else if(I){local e;while(e=Entities.Next(e)){local s=e.GetScriptScope();if(s){Msg(Fmt("\n--- Script dump for entity %s\n",""+e));DumpScope(s,0,1,0,1);Msg("--- End script dump\n")}}}}if(!PORTAL2){VS.GetLocalPlayer<-function(b=true){local e=::Entc("player");if(!e)return Msg("GetLocalPlayer: No player found!\n");if(e!=GetPlayerByIndex(1))Msg("GetLocalPlayer: Discrepancy!\n");SetName(e,"localplayer");if(b)::HPlayer<-e.weakref();return e}VS.GetPlayersAndBots<-function():(Entities){local e,P=[],B=[];while(e=Entities.FindByClassname(e,"cs_bot"))B.append(e.weakref());e=null;while(e=Entities.FindByClassname(e,"player")){local s=e.GetScriptScope();if("networkid"in s&&s.networkid=="BOT")B.append(e.weakref());else P.append(e.weakref())}return[P,B]}VS.GetAllPlayers<-function():(Entities){local e,a=[];while(e=Entities.FindByClassname(e,"player"))a.append(e.weakref());e=null;while(e=Entities.FindByClassname(e,"cs_bot"))a.append(e.weakref());return a}VS.DumpPlayers<-function(d=false):(Fmt){local a=GetPlayersAndBots(),p=a[0],b=a[1];Msg(Fmt("\n=======================================\n%d players found\n%d bots found\n",p.len(),b.len()));local c=function(_s,_a):(d,Fmt){foreach(e in _a){local s=e.GetScriptScope();if(s)s=GetVarName(s);if(!s)s="null";Msg(Fmt("%s - %s :: %s\n",_s,""+e,s));if(d&&s!="null")DumpEnt(e)}}c("[BOT]   ",b);c("[PLAYER]",p);Msg("=======================================\n")}}else{VS.GetLocalPlayer<-function(){local e;if(::IsMultiplayer())e=::Entc("player");else{e=::GetPlayer();if(e!=::player)Msg("GetLocalPlayer: Discrepancy!\n")};SetName(e,"localplayer");return e}};;VS.GetPlayerByIndex<-function(i):(Entities){local e;while(e=Entities.FindByClassname(e,"player"))if(e.entindex()==i)return e;e=null;while(e=Entities.FindByClassname(e,"cs_bot"))if(e.entindex()==i)return e}VS.GetEntityByIndex<-function(i,c="*"):(Entities){local e;while(e=Entities.FindByClassname(e,c))if(e.entindex()==i)return e}VS.IsPointSized<-function(h){local v=h.GetBoundingMaxs();return !v.x&&!v.y&&!v.z}VS.FindEntityNearestFacing<-function(org,dir,th):(Entities){local bd=th,be,e=Entities.First();while(e=Entities.Next(e)){local v=e.GetBoundingMaxs();if(!v.x&&!v.y&&!v.z)continue;local dt=e.GetOrigin()-org;dt.Norm();local dot=dir.Dot(dt);if(dot>bd){bd=dot;be=e}}return be}VS.FindEntityClassNearestFacing<-function(org,dir,th,cn):(Entities){local bd=th,be,e;while(e=Entities.FindByClassname(e,cn)){local dt=e.GetOrigin()-org;dt.Norm();local dot=dir.Dot(dt);if(dot>bd){bd=dot;be=e}}return be}VS.FindEntityClassNearestFacingNearest<-function(org,dir,th,cn,fr):(Entities){local xd,be,e;if(fr)xd=fr*fr;else xd=3.22122e+09;while(e=Entities.FindByClassname(e,cn)){local dt=e.GetOrigin()-org;dt.Norm();local dot=dir.Dot(dt);if(dot>th){local dq=(e.GetOrigin()-org).LengthSqr();if(xd>dq){be=e;xd=dq}}}return be}if(!PORTAL2&&(!(0 in::VS)||!(::VS[0]&0x10))){local Events=delegate::VS:{m_hProxy=null,m_bFixedUp=false,m_SV=null,m_Players=null,m_pSpawner=null,m_pListeners=null,s_szEventName=null,s_hListener=null,__rem=null,__tmp=null,Msg=Msg}VS.Events<-Events;if(!("{847D4B}"in ROOT))ROOT["{847D4B}"]<-array(64);;local gED=ROOT["{847D4B}"];VS.GetPlayerByUserid<-function(i):(Entities){if(m_Players&&i in m_Players)return m_Players[i];if(!m_Players)m_Players={};local p;while(p=Entities.FindByClassname(p,"player")){local s=p.GetScriptScope();if("userid"in s&&s.userid==i){m_Players[i]<-p.weakref();return p}}p=null;while(p=Entities.FindByClassname(p,"cs_bot")){local s=p.GetScriptScope();if("userid"in s&&s.userid==i){m_Players[i]<-p.weakref();return p}}}.bindenv(VS.Events);VS.Events.player_connect<-function(ev):(gED,ROOT){if(ev.networkid!=""){local x;foreach(i,v in gED)if(!gED[i]){x=i;break};if(x==null){for(local i=32;i<64;++i){gED[i-32]=gED[i];gED[i]=null}x=32;Msg("player_connect: ERROR!!! Player data is not being processed\n")};gED[x]=ev;if(!m_pListeners){local cr=GetCaller();if(!cr.parent||!cr.parent.rawin("{7D6E9A}")){Msg("player_connect: Warning: event listener is not fixed up!\n");m_bFixedUp=false}else m_bFixedUp=true;if("OnGameEvent_player_connect"in ROOT)::OnGameEvent_player_connect(ev)};return true};if(m_SV){local sc=m_SV.remove(0);if(!sc||!("self"in sc))return Msg("VS::ForceValidateUserid: invalid scope in validation\n");if(!sc.__vrefs||!sc.self||!sc.self.IsValid())return Msg("VS::ForceValidateUserid: invalid entity in validation\n");if("userid"in sc&&sc.userid!=ev.userid)Msg("VS::ForceValidateUserid: ERROR!!! conflict! ["+sc.userid+", "+ev.userid+"]\n");sc.userid<-ev.userid;if(!("name"in sc))sc.name<-"";if(!("networkid"in sc))sc.networkid<-"";if(!(0 in m_SV))m_SV=null}}.bindenv(VS.Events);VS.Events.player_spawn<-function(ev):(gED,Fmt,ROOT){foreach(i,dt in gED){if(!dt)break;if(dt.userid==ev.userid){local pl=GetPlayerByIndex(dt.index+1);if(!pl||!pl.ValidateScriptScope()){gED[i]=null;Msg("player_connect: invalid player entity ["+dt.userid+"] ["+(dt.index+1)+"]\n");break};local sc=pl.GetScriptScope();if("networkid"in sc&&sc.networkid!=""){Msg("player_connect: ERROR!!! Something has gone wrong! ");if(sc.networkid==dt.networkid){gED[i]=null;Msg(Fmt("Duplicated data. [%d]\n",dt.userid))}else Msg(Fmt("Conflicting data. [%d] ('%s', '%s')\n",dt.userid,sc.networkid,dt.networkid));break};sc.userid<-dt.userid;sc.name<-dt.name;sc.networkid<-dt.networkid;gED[i]=null;gED.sort();gED.reverse();break}}if(!m_pListeners){local cr=GetCaller();if(!cr.parent||!cr.parent.rawin("{7D6E9A}"))Msg("player_spawn: Warning: event listener is not fixed up!\n");if("OnGameEvent_player_spawn"in ROOT)return::OnGameEvent_player_spawn(ev)}}.bindenv(VS.Events);VS.ForceValidateUserid<-function(p):(AddEvent,Fmt,Entities){if(!p||!p.IsValid()||(p.GetClassname()!="player")||!p.ValidateScriptScope())return Msg(Fmt("VS::ForceValidateUserid: invalid input: %s\n",""+p));if(!m_SV)m_SV=[];local sc=p.GetScriptScope(),b=1;foreach(v in m_SV)if(v==sc){b=0;break};if(b)m_SV.append(sc.weakref());if(!m_hProxy){local h=Entities.CreateByClassname("info_game_event_proxy");h.__KeyValueFromString("event_name","player_connect");MakePersistent(h);m_hProxy=h.weakref()};return AddEvent(m_hProxy,"GenerateGameEvent","",0,p,null)}.bindenv(VS.Events);VS.ValidateUseridAll<-function(){if(Events.m_bFixedUp){foreach(i,v in GetAllPlayers())if(!("userid"in v.GetScriptScope()))ForceValidateUserid(v)}else{Msg("VS::ValidateUseridAll: Warning: player_connect event listener is not fixed up!");local d=::delay,t=::FrameTime();foreach(i,v in GetAllPlayers())d("::VS.ForceValidateUserid(self)",i*t,v)}}VS.Events.ForceValidateUserid<-VS.ForceValidateUserid.weakref();VS.Events.ValidateUseridAll<-VS.ValidateUseridAll.weakref();VS.FixupEventListener<-function(p){if(!p||!p.IsValid()||(p.GetClassname()!="logic_eventlistener")||!p.ValidateScriptScope())return Msg("VS::FixupEventListener: invalid event listener input\n");local sc=p.GetScriptScope();if(sc.parent.rawin("{7D6E9A}"))return Msg("VS::FixupEventListener: already fixed up "+p+"\n");local c=[];sc.rawdelete("event_data");delegate(delegate(delegate sc.parent:{_delslot=function(k){delete parent.parent[k]}}):{_newslot=function(k,v):(c){if(k=="event_data")c.insert(0,v);else rawset(k,v)},_get=function(k):(c){if(k=="event_data")return c.pop();return rawget(k)},["{7D6E9A}"]=null}):sc}local __RemovePooledString=function(sz){__rem=sz;m_pSpawner.SpawnEntity();__rem=null}.bindenv(VS.Events);VS.Events.SpawnEntity<-function(ev):(Entities){if(!m_pSpawner){local h=Entities.CreateByClassname("env_entity_maker");h.__KeyValueFromString("EntityTemplate","vs.eventlistener");MakePersistent(h);m_pSpawner=h.weakref()};s_szEventName=ev;m_pSpawner.SpawnEntity();local r=s_hListener;s_szEventName=s_hListener=null;return r}VS.Events.__ExecutePreSpawn<-function(p){local vs=VS.Events;if(vs.__rem){p.__KeyValueFromString("targetname",vs.__rem);p.__KeyValueFromString("EventName","player_connect");p.Destroy();return};local ev=vs.s_szEventName;if(!ev){p.Destroy();return Msg("VS::Events::PreSpawn: invalid call origin\n")};p.__KeyValueFromString("EventName",ev);p.__KeyValueFromInt("FetchEventData",1);p.__KeyValueFromInt("IsEnabled",1);p.__KeyValueFromInt("TeamNum",-1);__EntityMakerResult={}}VS.Events.__FinishSpawn<-function(){__EntityMakerResult=null}VS.Events.PostSpawn<-function(pE):(AddEvent){foreach(e in pE){s_hListener=e;FixupEventListener(e);MakePersistent(e);local sc=e.GetScriptScope();local n=sc.__vname;local i=n.find("_");n=s_szEventName+"_"+n.slice(0,i);e.__KeyValueFromString("targetname",n);AddEvent(e,"AddOutput","OnEventFired "+n+",CallScriptFunction,OnEventFired",0.0,null,e);sc.OnEventFired<-null}}.bindenv(VS.Events);VS.Events.OnPostSpawn<-function():(__RemovePooledString){local VS=VS;if(!VS.Events.m_bFixedUp){VS.Events.m_bFixedUp=true;Msg("VS::Events init\n");VS.StopListeningToAllGameEvents("VS::Events");VS.ListenToGameEvent("player_connect",function(ev){if(player_connect(ev)){foreach(fn in m_pListeners.player_connect)if(typeof fn=="function")fn(ev)}}.bindenv(VS.Events),"VS::Events");VS.ListenToGameEvent("player_spawn",function(ev){player_spawn(ev);foreach(fn in m_pListeners.player_spawn)if(typeof fn=="function")fn(ev)}.bindenv(VS.Events),"VS::Events");VS.ListenToGameEvent("player_activate",function(ev){return ValidateUseridAll()}.bindenv(VS),"VS::Events");VS.ListenToGameEvent("player_disconnect",function(ev){if(m_Players&&ev.userid in m_Players)delete m_Players[ev.userid]}.bindenv(VS.Events),"VS::Events")};if(VS.Events.__tmp)__RemovePooledString(VS.Events.__tmp);VS.Events.__tmp=__vname}VS.ListenToGameEvent<-function(ev,fn,cx){if((typeof fn!="function")&&(typeof fn!="native function"))throw"invalid callback param";if(typeof cx!="string")throw"invalid context param";if(!m_pListeners)m_pListeners={};if(!(ev in m_pListeners))m_pListeners[ev]<-{};local l=m_pListeners[ev];if(!(cx in l))l[cx]<-null;if((ev=="player_connect"||ev=="player_spawn")&&(cx!="VS::Events")){l[cx]=fn;return};local p=l[cx];if(!p){if(!(p=SpawnEntity(ev)))return Msg("VS::ListenToGameEvent: ERROR!!! NULL ent!\n");l[cx]=p.weakref()};local sc=p.GetScriptScope();sc.OnEventFired<-function():(fn){return fn(event_data)}}.bindenv(VS.Events);VS.StopListeningToAllGameEvents<-function(cx):(__RemovePooledString){if(m_pListeners)foreach(l in m_pListeners)if(cx in l){local p=l[cx];if(p&&typeof p=="instance"){__RemovePooledString("OnEventFired "+p.GetName()+",CallScriptFunction,OnEventFired");p.Destroy()};delete l[cx]}}.bindenv(VS.Events);local __ExecutePreSpawn=delete VS.Events.__ExecutePreSpawn,__FinishSpawn=delete VS.Events.__FinishSpawn,PostSpawn=delete VS.Events.PostSpawn,OnPostSpawn=delete VS.Events.OnPostSpawn;VS.Events.InitTemplate<-function(sc):(__ExecutePreSpawn,__FinishSpawn,PostSpawn,OnPostSpawn){local self;if(!("self"in sc)||!(self=sc.self)||!self.IsValid()||self.GetClassname()!="point_template")throw"VS::Events::InitTemplate: invalid entity";self.__KeyValueFromInt("spawnflags",0);self.__KeyValueFromString("targetname","vs.eventlistener");sc.__EntityMakerResult<-null;sc.__ExecutePreSpawn<-__ExecutePreSpawn;sc.__FinishSpawn<-__FinishSpawn;sc.PreSpawnInstance<-1;sc.PostSpawn<-PostSpawn;sc.OnPostSpawn<-OnPostSpawn.bindenv(sc)}};;{local Log={enabled=false,export=false,file_prefix="vs.log",filter="L ",m_data=[],_data=null,_cb=null,_env=null}VS.Log<-Log;Log._data=Log.m_data.weakref();Log.Add<-function(s){local L=_data;L.insert(L.len(),s)}.bindenv(Log);Log.Pop<-function(){return _data.pop()}.bindenv(Log);Log.Clear<-function(){_data.clear()}.bindenv(Log);Log.Run<-function(d=null,cb=null){if(!enabled)return;_data=d?d.weakref():m_data.weakref();_cb=typeof cb=="function"?cb:null;_env=_cb?VS.GetCaller():null;return _Start()}.bindenv(Log);local dl=VS.EventQueue.AddEvent,Cmd=SendToConsole;VS.Log._Write<-function():(Msg,dl){local t=filter,p=Msg,L=_data;if(!export)for(local i=nC;i<nN;++i)p(L[i]);else for(local i=nC;i<nN;++i)p(t+L[i]);nC+=nD;local a=nN+nD;nN=a<nL?a:nL;if(nC>=nN){_data=m_data.weakref();nL=null;nD=null;nC=null;nN=null;return _Stop()};return dl(_Write,0.001,this)}VS.Log._Start<-function():(Cmd,developer,Fmt,TI){nL<-_data.len();nD<-2000;nC<-0;nN<-nD<nL?nD:nL;if(export){local f=file_prefix[0]==':'?file_prefix.slice(1):Fmt("%s_%s",file_prefix,VS.UniqueString());_d<-developer();Cmd(Fmt("developer 0;con_filter_enable 1;con_filter_text_out\"%s\";con_filter_text\"\";con_logfile\"%s.log\";script VS.EventQueue.AddEvent(VS.Log._Write,%.6g,VS.Log)",filter,f,TI*4.0));return f}else Cmd("script VS.Log._Write()")}VS.Log._Stop<-function():(Cmd){if(export)Cmd("con_logfile\"\";con_filter_text_out\"\";con_filter_text\"\";con_filter_enable 0;developer "+_d+";script VS.Log._Dispatch()");else _Dispatch()}VS.Log._Dispatch<-function(){if(_cb){_cb.pcall(_env);_cb=null;_env=null}}}{local gVS=::VS;if(!gVS.len()){foreach(k,v in VS)gVS[k]<-v;return::collectgarbage()};if(VS==gVS)return::collectgarbage();if(gVS.version==VS.version){local n=gVS[0]|VS[0];foreach(k,v in VS){if(k=="Events")continue;gVS[k]<-v}gVS[0]=n;return::collectgarbage()};local vnt="",vst=gVS.version;local c=vst.len();for(local i=0;i<c;++i){local ch=vst[i];if(ch>='0'&&ch<='9')vnt+=ch.tochar()}if(vnt==""){vnt=0;Msg("VS: invalid version number ("+vst+")!\n")};vnt=vnt.tointeger();local vni="",vsi=VS.version;c=vsi.len();for(local i=0;i<c;++i){local ch=vsi[i];if(ch>='0'&&ch<='9')vni+=ch.tochar()}if(vni==""){vni=0;Msg("VS: invalid version number ("+vsi+")\n")};vni=vni.tointeger();if(vnt==vni){Msg("VS: non-matching version strings!\n");return::collectgarbage()};if(vnt<vni){foreach(k,v in VS){if(k=="Events")continue;gVS[k]<-v}}else{foreach(k,v in VS){if(k=="Events")continue;if(!(k in gVS))gVS[k]<-v}};VS=null;return::collectgarbage()}
